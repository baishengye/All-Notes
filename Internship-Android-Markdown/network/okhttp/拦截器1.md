## æ‹¦æˆªå™¨è¯¦è§£1ï¼šé‡è¯•é‡å®šå‘ã€æ¡¥ã€ç¼“å­˜ï¼ˆé‡ç‚¹ï¼‰

å…ˆå›é¡¾ä¸‹`RealCall`çš„`getResponseWithInterceptorChain`æ–¹æ³•â€”â€”æ‹¦æˆªå™¨çš„æ·»åŠ ä»¥åŠæ‹¦æˆªå™¨é“¾çš„æ‰§è¡Œï¼š
```java
  Response getResponseWithInterceptorChain() throws IOException {
    // åˆ›å»ºä¸€ç³»åˆ—æ‹¦æˆªå™¨
    List<Interceptor> interceptors = new ArrayList<>();
    interceptors.addAll(client.interceptors());
    interceptors.add(new RetryAndFollowUpInterceptor(client));
    interceptors.add(new BridgeInterceptor(client.cookieJar()));
    interceptors.add(new CacheInterceptor(client.internalCache()));
    interceptors.add(new ConnectInterceptor(client));
    if (!forWebSocket) {
      interceptors.addAll(client.networkInterceptors());
    }
    interceptors.add(new CallServerInterceptor(forWebSocket));

    Interceptor.Chain chain = new RealInterceptorChain(interceptors, transmitter, null, 0,
        originalRequest, this, client.connectTimeoutMillis(),
        client.readTimeoutMillis(), client.writeTimeoutMillis());
    ...
      //æ‹¦æˆªå™¨é“¾çš„æ‰§è¡Œ
      Response response = chain.proceed(originalRequest);
      ...
      return response;
    ...
  }
```

### 1. `RetryAndFollowUpInterceptor` - é‡è¯•ã€é‡å®šå‘
å¦‚æœè¯·æ±‚åˆ›å»ºæ—¶æ²¡æœ‰æ·»åŠ åº”ç”¨æ‹¦æˆªå™¨ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨å°±æ˜¯`RetryAndFollowUpInterceptor`ï¼Œæ„ä¸ºâ€œé‡è¯•å’Œè·Ÿè¿›æ‹¦æˆªå™¨â€ï¼Œä½œç”¨æ˜¯è¿æ¥å¤±è´¥åè¿›è¡Œé‡è¯•ã€å¯¹è¯·æ±‚ç»“æœè·Ÿè¿›åè¿›è¡Œé‡å®šå‘ã€‚ç›´æ¥çœ‹å®ƒçš„interceptæ–¹æ³•ï¼š
```java
  @Override public Response intercept(Chain chain) throws IOException {
    Request request = chain.request();
    RealInterceptorChain realChain = (RealInterceptorChain) chain;
    Transmitter transmitter = realChain.transmitter();

    int followUpCount = 0;
    Response priorResponse = null;
    
    while (true) {
      //å‡†å¤‡è¿æ¥
      transmitter.prepareToConnect(request);
      
      if (transmitter.isCanceled()) {
        throw new IOException("Canceled");
      }

      Response response;
      boolean success = false;
      try {
        //ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªInterceptor
        response = realChain.proceed(request, transmitter, null);
        success = true;
      } catch (RouteException e) {
        // è¿æ¥è·¯ç”±å¼‚å¸¸ï¼Œæ­¤æ—¶è¯·æ±‚è¿˜æœªå‘é€ã€‚å°è¯•æ¢å¤~
        if (!recover(e.getLastConnectException(), transmitter, false, request)) {
          throw e.getFirstConnectException();
        }
        continue;
      } catch (IOException e) {
        // IOå¼‚å¸¸ï¼Œè¯·æ±‚å¯èƒ½å·²ç»å‘å‡ºã€‚å°è¯•æ¢å¤~
        boolean requestSendStarted = !(e instanceof ConnectionShutdownException);
        if (!recover(e, transmitter, requestSendStarted, request)) throw e;
        continue;
      } finally {
        // è¯·æ±‚æ²¡æˆåŠŸï¼Œé‡Šæ”¾èµ„æºã€‚
        if (!success) {
          transmitter.exchangeDoneDueToException();
        }
      }

      // å…³è”ä¸Šä¸€ä¸ªresponse
      if (priorResponse != null) {
        response = response.newBuilder()
            .priorResponse(priorResponse.newBuilder()
                    .body(null)
                    .build())
            .build();
      }

      Exchange exchange = Internal.instance.exchange(response);
      Route route = exchange != null ? exchange.connection().route() : null;
      //è·Ÿè¿›ç»“æœï¼Œä¸»è¦ä½œç”¨æ˜¯æ ¹æ®å“åº”ç å¤„ç†è¯·æ±‚ï¼Œè¿”å›Requestä¸ä¸ºç©ºæ—¶åˆ™è¿›è¡Œé‡å®šå‘å¤„ç†-æ‹¿åˆ°é‡å®šå‘çš„request
      Request followUp = followUpRequest(response, route);

	  //followUpä¸ºç©ºï¼Œä¸éœ€è¦é‡è¯•ï¼Œç›´æ¥è¿”å›
      if (followUp == null) {
        if (exchange != null && exchange.isDuplex()) {
          transmitter.timeoutEarlyExit();
        }
        return response;
      }

	  //followUpBody.isOneShotï¼Œä¸éœ€è¦é‡è¯•ï¼Œç›´æ¥è¿”å›
      RequestBody followUpBody = followUp.body();
      if (followUpBody != null && followUpBody.isOneShot()) {
        return response;
      }

      closeQuietly(response.body());
      if (transmitter.hasExchange()) {
        exchange.detachWithViolence();
      }

	  //æœ€å¤šé‡è¯•20æ¬¡
      if (++followUpCount > MAX_FOLLOW_UPS) {
        throw new ProtocolException("Too many follow-up requests: " + followUpCount);
      }
      //èµ‹å€¼ï¼Œä»¥ä¾¿å†æ¬¡è¯·æ±‚
      request = followUp;
      priorResponse = response;
    }
  }
```
ä½¿ç”¨`while`è¿›è¡Œå¾ªç¯ï¼š
å…ˆç”¨`transmitter.prepareToConnect(request)`è¿›è¡Œè¿æ¥å‡†å¤‡ã€‚`transmitter`åœ¨ä¸Šä¸€ç¯‡æœ‰æåˆ°ï¼Œæ„ä¸ºå‘å°„å™¨ï¼Œæ˜¯åº”ç”¨å±‚å’Œç½‘ç»œå±‚çš„æ¡¥æ¢ï¼Œåœ¨è¿›è¡Œ è¿æ¥ã€çœŸæ­£å‘å‡ºè¯·æ±‚å’Œè¯»å–å“åº”ä¸­èµ·åˆ°å¾ˆé‡è¦çš„ä½œç”¨ã€‚çœ‹ä¸‹`prepareToConnect`æ–¹æ³•ï¼š
```java
  public void prepareToConnect(Request request) {
    if (this.request != null) {
      if (sameConnection(this.request.url(), request.url()) && exchangeFinder.hasRouteToTry()) {
        return; //å·²æœ‰ç›¸åŒè¿æ¥
      }
      ...
    }

    this.request = request;
    //åˆ›å»ºExchangeFinderï¼Œç›®çš„æ˜¯ä¸ºè·å–è¿æ¥åšå‡†å¤‡
    this.exchangeFinder = new ExchangeFinder(this, connectionPool, createAddress(request.url()),
        call, eventListener);
  }
```
ä¸»è¦æ˜¯åˆ›å»º`ExchangeFinder`æ¢³ç†èµ‹å€¼ç»™`transmitter.exchangeFinder`ã€‚`ExchangeFinder`æ˜¯äº¤æ¢æŸ¥æ‰¾å™¨ï¼Œä½œç”¨æ˜¯è·å–è¯·æ±‚çš„è¿æ¥ã€‚è¿™é‡Œå…ˆäº†è§£ä¸‹ï¼Œåé¢ä¼šå…·ä½“è¯´æ˜ã€‚
æ¥ç€è°ƒç”¨`realChain.proceed` ç»§ç»­ä¼ é€’è¯·æ±‚ç»™ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ã€ä»ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨è·å–åŸå§‹ç»“æœã€‚å¦‚æœæ­¤è¿‡ç¨‹å‘ç”Ÿäº† è¿æ¥è·¯ç”±å¼‚å¸¸ æˆ– IOå¼‚å¸¸ï¼Œå°±ä¼šè°ƒç”¨`recover`åˆ¤æ–­æ˜¯å¦è¿›è¡Œé‡è¯•æ¢å¤ã€‚çœ‹ä¸‹`recover`æ–¹æ³•ï¼š
```java
  private boolean recover(IOException e, Transmitter transmitter,
      boolean requestSendStarted, Request userRequest) {
    // åº”ç”¨å±‚ç¦æ­¢é‡è¯•ï¼Œå°±ä¸é‡è¯•
    if (!client.retryOnConnectionFailure()) return false;

    // ä¸èƒ½å†æ¬¡å‘é€è¯·æ±‚ï¼Œå°±ä¸é‡è¯•
    if (requestSendStarted && requestIsOneShot(e, userRequest)) return false;

    // å‘ç”Ÿçš„å¼‚å¸¸æ˜¯è‡´å‘½çš„ï¼Œå°±ä¸é‡è¯•
    if (!isRecoverable(e, requestSendStarted)) return false;

    // æ²¡æœ‰è·¯ç”±å¯ä»¥å°è¯•ï¼Œå°±ä¸é‡è¯•
    if (!transmitter.canRetry()) return false;

    return true;
  }
```
å¦‚æœ`recover`æ–¹æ³•è¿”å›`true`ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œé‡æ–°è¯·æ±‚ã€‚
å¦‚æœ`realChain.proceed`æ²¡æœ‰å‘ç”Ÿå¼‚å¸¸ï¼Œè¿”å›äº†ç»“æœ`response`ï¼Œå°±ä¼šä½¿ç”¨`followUpRequest`æ–¹æ³•è·Ÿè¿›ç»“æœå¹¶æ„å»ºé‡å®šå‘`request`ã€‚ å¦‚æœä¸ç”¨è·Ÿè¿›å¤„ç†ï¼ˆä¾‹å¦‚å“åº”ç æ˜¯`200`ï¼‰ï¼Œåˆ™è¿”å›`null`ã€‚çœ‹ä¸‹`followUpRequest`æ–¹æ³•ï¼š
```java
  private Request followUpRequest(Response userResponse, @Nullable Route route) throws IOException {
  ...
    int responseCode = userResponse.code();
  ...
    switch (responseCode) {
      ...
      case HTTP_PERM_REDIRECT:
      case HTTP_TEMP_REDIRECT:
        if (!method.equals("GET") && !method.equals("HEAD")) {
          return null;
        }
      case HTTP_MULT_CHOICE:
      case HTTP_MOVED_PERM:
      case HTTP_MOVED_TEMP:
      case HTTP_SEE_OTHER:
        if (!client.followRedirects()) return null;

        String location = userResponse.header("Location");
        if (location == null) return null;
        HttpUrl url = userResponse.request().url().resolve(location);

        if (url == null) return null;
        boolean sameScheme = url.scheme().equals(userResponse.request().url().scheme());
        if (!sameScheme && !client.followSslRedirects()) return null;

        Request.Builder requestBuilder = userResponse.request().newBuilder();
        if (HttpMethod.permitsRequestBody(method)) {
          final boolean maintainBody = HttpMethod.redirectsWithBody(method);
          if (HttpMethod.redirectsToGet(method)) {
            requestBuilder.method("GET", null);
          } else {
            RequestBody requestBody = maintainBody ? userResponse.request().body() : null;
            requestBuilder.method(method, requestBody);
          }
          if (!maintainBody) {
            requestBuilder.removeHeader("Transfer-Encoding");
            requestBuilder.removeHeader("Content-Length");
            requestBuilder.removeHeader("Content-Type");
          }
        }
        if (!sameConnection(userResponse.request().url(), url)) {
          requestBuilder.removeHeader("Authorization");
        }

        return requestBuilder.url(url).build();

      case HTTP_CLIENT_TIMEOUT:
        ...
      default:
        return null;
    }
  }
```
ä¸»è¦å°±æ˜¯æ ¹æ®å“åº”ç åˆ¤æ–­å¦‚æœéœ€è¦é‡å®šå‘ï¼Œå°±ä»å“åº”ä¸­å–å‡ºé‡å®šå‘çš„`url`å¹¶æ„å»ºæ–°çš„`Request`å¹¶è¿”å›å‡ºå»ã€‚
å¾€ä¸‹çœ‹ï¼Œè¿˜æœ‰ä¸ªåˆ¤æ–­ï¼šæœ€å¤šé‡è¯•`20`æ¬¡ã€‚åˆ°è¿™é‡Œï¼Œ`RetryAndFollowUpInterceptor`å°±è®²å®Œäº†ï¼Œè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä¸»è¦å°±æ˜¯è¿æ¥å¤±è´¥çš„é‡è¯•ã€è·Ÿè¿›å¤„ç†é‡å®šå‘ã€‚

### 2. `BridgeInterceptor` - æ¡¥æ¥æ‹¦æˆªå™¨
æ¥ç€æ˜¯ `BridgeInterceptor` ï¼Œæ„ä¸º æ¡¥æ‹¦æˆªå™¨ï¼Œç›¸å½“äº åœ¨ è¯·æ±‚å‘èµ·ç«¯ å’Œ ç½‘ç»œæ‰§è¡Œç«¯ æ¶èµ·ä¸€åº§æ¡¥ï¼ŒæŠŠåº”ç”¨å±‚å‘å‡ºçš„è¯·æ±‚ å˜ä¸º ç½‘ç»œå±‚è®¤è¯†çš„è¯·æ±‚ï¼ŒæŠŠç½‘ç»œå±‚æ‰§è¡Œåçš„å“åº” å˜ä¸º åº”ç”¨å±‚ä¾¿äºåº”ç”¨å±‚ä½¿ç”¨çš„ç»“æœã€‚  çœ‹ä»£ç ï¼š
```java
//æ¡¥æ‹¦æˆªå™¨
public final class BridgeInterceptor implements Interceptor {

  //Cookieç®¡ç†å™¨ï¼Œåˆå§‹åŒ–OkhttpClientæ—¶åˆ›å»ºçš„ï¼Œé»˜è®¤æ˜¯CookieJar.NO_COOKIES
  private final CookieJar cookieJar;

  public BridgeInterceptor(CookieJar cookieJar) {
    this.cookieJar = cookieJar;
  }

  @Override public Response intercept(Chain chain) throws IOException {
    Request userRequest = chain.request();
    Request.Builder requestBuilder = userRequest.newBuilder();
    
    RequestBody body = userRequest.body();
    if (body != null) {
      MediaType contentType = body.contentType();
      if (contentType != null) {
        requestBuilder.header("Content-Type", contentType.toString());
      }

      long contentLength = body.contentLength();
      //å¦‚æœå·²ç»çŸ¥é“bodyçš„é•¿åº¦ï¼Œå°±æ·»åŠ å¤´éƒ¨"Content-Length"
      if (contentLength != -1) {
        requestBuilder.header("Content-Length", Long.toString(contentLength));
        requestBuilder.removeHeader("Transfer-Encoding");
      } else {
      //å¦‚æœä¸çŸ¥é“bodyçš„é•¿åº¦ï¼Œå°±æ·»åŠ å¤´éƒ¨"Transfer-Encoding"ï¼Œä»£è¡¨è¿™ä¸ªæŠ¥æ–‡é‡‡ç”¨äº†åˆ†å—ç¼–ç ã€‚è¿™æ—¶ï¼ŒæŠ¥æ–‡ä¸­çš„å®ä½“éœ€è¦æ”¹ä¸ºç”¨ä¸€ç³»åˆ—åˆ†å—æ¥ä¼ è¾“ã€‚å…·ä½“ç†è§£è¯·å‚è€ƒï¼š[HTTP Transfer-Encodingä»‹ç»](https://blog.csdn.net/Dancen/article/details/89957486)
        requestBuilder.header("Transfer-Encoding", "chunked");
        requestBuilder.removeHeader("Content-Length");
      }
    }

    if (userRequest.header("Host") == null) {
      requestBuilder.header("Host", hostHeader(userRequest.url(), false));
    }

    if (userRequest.header("Connection") == null) {
      requestBuilder.header("Connection", "Keep-Alive");
    }

	//"Accept-Encoding: gzip",è¡¨ç¤ºæ¥å—ï¼šè¿”å›gzipç¼–ç å‹ç¼©çš„æ•°æ®
    // å¦‚æœæˆ‘ä»¬æ‰‹åŠ¨æ·»åŠ äº† "Accept-Encoding: gzip" ï¼Œé‚£ä¹ˆä¸‹é¢çš„ifä¸ä¼šè¿›å…¥ï¼ŒtransparentGzipæ˜¯falseï¼Œå°±éœ€è¦æˆ‘ä»¬è‡ªå·±å¤„ç†æ•°æ®è§£å‹ã€‚
    //å¦‚æœ æ²¡æœ‰ æ‰‹åŠ¨æ·»åŠ "Accept-Encoding: gzip" ï¼ŒtransparentGzipæ˜¯trueï¼ŒåŒæ—¶ä¼šè‡ªåŠ¨æ·»åŠ ï¼Œè€Œä¸”åé¢ä¹Ÿä¼šè‡ªåŠ¨å¤„ç†è§£å‹ã€‚
    boolean transparentGzip = false;
    if (userRequest.header("Accept-Encoding") == null && userRequest.header("Range") == null) {
      transparentGzip = true;
      requestBuilder.header("Accept-Encoding", "gzip");
    }
	//ä»cookieJarä¸­è·å–cookieï¼Œæ·»åŠ åˆ°header
    List<Cookie> cookies = cookieJar.loadForRequest(userRequest.url());
    if (!cookies.isEmpty()) {
      requestBuilder.header("Cookie", cookieHeader(cookies));
    }
	//"User-Agent"ä¸€èˆ¬éœ€è¦ä½œä¸ºå…¬å…±headerå¤–éƒ¨ç»Ÿä¸€æ·»åŠ 
    if (userRequest.header("User-Agent") == null) {
      requestBuilder.header("User-Agent", Version.userAgent());
    }

	//å¤„ç†è¯·æ±‚
    Response networkResponse = chain.proceed(requestBuilder.build());
	//ä»networkResponseä¸­è·å– header "Set-Cookie" å­˜å…¥cookieJar
    HttpHeaders.receiveHeaders(cookieJar, userRequest.url(), networkResponse.headers());

    Response.Builder responseBuilder = networkResponse.newBuilder()
        .request(userRequest);

	//å¦‚æœæˆ‘ä»¬æ²¡æœ‰æ‰‹åŠ¨æ·»åŠ "Accept-Encoding: gzip"ï¼Œè¿™é‡Œä¼šåˆ›å»º èƒ½è‡ªåŠ¨è§£å‹çš„responseBody--GzipSource
    if (transparentGzip
        && "gzip".equalsIgnoreCase(networkResponse.header("Content-Encoding"))
        && HttpHeaders.hasBody(networkResponse)) {
      GzipSource responseBody = new GzipSource(networkResponse.body().source());
      Headers strippedHeaders = networkResponse.headers().newBuilder()
          .removeAll("Content-Encoding")
          .removeAll("Content-Length")
          .build();
      responseBuilder.headers(strippedHeaders);
      String contentType = networkResponse.header("Content-Type");
      responseBuilder.body(new RealResponseBody(contentType, -1L, Okio.buffer(responseBody)));
    }
	//ç„¶åæ„å»º æ–°çš„responseè¿”å›å‡ºå»
    return responseBuilder.build();
  }
  
  private String cookieHeader(List<Cookie> cookies) {
    StringBuilder cookieHeader = new StringBuilder();
    for (int i = 0, size = cookies.size(); i < size; i++) {
      if (i > 0) {
        cookieHeader.append("; ");
      }
      Cookie cookie = cookies.get(i);
      cookieHeader.append(cookie.name()).append('=').append(cookie.value());
    }
    return cookieHeader.toString();
  }
}
```
é¦–å…ˆï¼Œ`chain.proceed()` æ‰§è¡Œå‰ï¼Œå¯¹ è¯·æ±‚æ·»åŠ äº†`headerï¼š"Content-Type"ã€"Content-Length"` æˆ– `"Transfer-Encoding"ã€"Host"ã€"Connection"ã€"Accept-Encoding"ã€"Cookie"ã€"User-Agent"`ï¼Œå³ç½‘ç»œå±‚çœŸæ­£å¯æ‰§è¡Œçš„è¯·æ±‚ã€‚å…¶ä¸­ï¼Œæ³¨æ„åˆ°ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰`cookie`å¤„ç†çš„ï¼Œéœ€è¦æˆ‘ä»¬åœ¨åˆå§‹åŒ–`OkhttpClient`æ—¶é…ç½®æˆ‘ä»¬è‡ªå·±çš„`cookieJar`ã€‚
`chain.proceed()` æ‰§è¡Œåï¼Œå…ˆæŠŠå“åº”`header`ä¸­çš„`cookie`å­˜å…¥`cookieJar`ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œç„¶åå¦‚æœæ²¡æœ‰æ‰‹åŠ¨æ·»åŠ è¯·æ±‚`header "Accept-Encoding: gzip"`ï¼Œé‚£ä¹ˆä¼šé€šè¿‡ åˆ›å»ºèƒ½è‡ªåŠ¨è§£å‹çš„`responseBodyâ€”â€”GzipSource`ï¼Œæ¥ç€æ„å»ºæ–°çš„`response`è¿”å›ã€‚
çœ‹èµ·æ¥`BridgeInterceptor`ä¹Ÿæ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ã€‚

### 3. `CacheInterceptor` - ç¼“å­˜æ‹¦æˆªå™¨
`CacheInterceptor`ï¼Œç¼“å­˜æ‹¦æˆªå™¨ï¼Œæä¾›ç½‘ç»œè¯·æ±‚ç¼“å­˜çš„å­˜å–ã€‚
æˆ‘ä»¬å‘èµ·ä¸€ä¸ªç½‘ç»œè¯·æ±‚ï¼Œå¦‚æœæ¯æ¬¡éƒ½ç»è¿‡ç½‘ç»œçš„å‘é€å’Œè¯»å–ï¼Œé‚£ä¹ˆæ•ˆç‡ä¸Šæ˜¯æœ‰æ¬ ç¼ºçš„ã€‚å¦‚æœä¹‹å‰æœ‰ç›¸åŒçš„è¯·æ±‚å·²ç»æ‰§è¡Œè¿‡ä¸€æ¬¡ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥æŠŠå®ƒçš„ç»“æœå­˜èµ·æ¥ï¼Œç„¶åè¿™æ¬¡è¯·æ±‚ç›´æ¥ä½¿ç”¨å‘¢ï¼Ÿ `CacheInterceptor`å¹²çš„å°±æ˜¯è¿™ä¸ªäº‹ï¼Œåˆç†ä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œæœ‰æ•ˆåœ°å‡å°‘ç½‘ç»œå¼€é”€ã€å‡å°‘å“åº”å»¶è¿Ÿã€‚

åœ¨è§£æ`CacheInterceptor`æºç å‰ï¼Œå…ˆäº†è§£ä¸‹httpçš„ç¼“å­˜æœºåˆ¶ï¼š
ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼š
![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b5f779033daf~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)

ç¬¬äºŒæ¬¡è¯·æ±‚ï¼š
![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/5/31/1726b5f779755ba1~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)

ä¸Šé¢ä¸¤å¼ å›¾å¾ˆå¥½çš„è§£é‡Šäº†httpçš„ç¼“å­˜æœºåˆ¶ï¼šæ ¹æ® ç¼“å­˜æ˜¯å¦è¿‡æœŸã€è¿‡æœŸåæ˜¯å¦æœ‰ä¿®æ”¹ æ¥å†³å®š è¯·æ±‚æ˜¯å¦ä½¿ç”¨ç¼“å­˜ã€‚è¯¦ç»†è¯´æ˜å¯ç‚¹å‡»äº†è§£ **å½»åº•å¼„æ‡‚HTTPç¼“å­˜æœºåˆ¶åŠåŸç†**ï¼›

`CacheInterceptor`çš„`intercept`æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š
```java
  public Response intercept(Chain chain) throws IOException {
  	//ç”¨requesçš„url ä»ç¼“å­˜ä¸­ è·å–å“åº” ä½œä¸ºå€™é€‰ï¼ˆCacheStrategyå†³å®šæ˜¯å¦ä½¿ç”¨ï¼‰ã€‚
    Response cacheCandidate = cache != null
        ? cache.get(chain.request())
        : null;

    long now = System.currentTimeMillis();
	//æ ¹æ® requestã€å€™é€‰Response è·å–ç¼“å­˜ç­–ç•¥ã€‚
	//ç¼“å­˜ç­–ç•¥ å°†å†³å®šæ˜¯å¦ ä½¿ç”¨ç¼“å­˜ï¼šstrategy.networkRequestä¸ºnullï¼Œä¸ä½¿ç”¨ç½‘ç»œï¼›strategy.cacheResponseä¸ºnullï¼Œä¸ä½¿ç”¨ç¼“å­˜ã€‚
    CacheStrategy strategy = new CacheStrategy.Factory(now, chain.request(), cacheCandidate).get();
    Request networkRequest = strategy.networkRequest;
    Response cacheResponse = strategy.cacheResponse;
	
	//æ ¹æ®ç¼“å­˜ç­–ç•¥æ›´æ–°ç»Ÿè®¡æŒ‡æ ‡ï¼šè¯·æ±‚æ¬¡æ•°ã€ç½‘ç»œè¯·æ±‚æ¬¡æ•°ã€ä½¿ç”¨ç¼“å­˜æ¬¡æ•°
    if (cache != null) {
      cache.trackResponse(strategy);
    }
	//æœ‰ç¼“å­˜ ä½†ä¸èƒ½ç”¨ï¼Œå…³æ‰
    if (cacheCandidate != null && cacheResponse == null) {
      closeQuietly(cacheCandidate.body()); // The cache candidate wasn't applicable. Close it.
    }

    // ç½‘ç»œè¯·æ±‚ã€ç¼“å­˜ éƒ½ä¸èƒ½ç”¨ï¼Œå°±è¿”å›504
    if (networkRequest == null && cacheResponse == null) {
      return new Response.Builder()
          .request(chain.request())
          .protocol(Protocol.HTTP_1_1)
          .code(504)
          .message("Unsatisfiable Request (only-if-cached)")
          .body(Util.EMPTY_RESPONSE)
          .sentRequestAtMillis(-1L)
          .receivedResponseAtMillis(System.currentTimeMillis())
          .build();
    }

    // å¦‚æœä¸ç”¨ç½‘ç»œï¼ŒcacheResponseè‚¯å®šä¸ä¸ºç©ºäº†ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨ç¼“å­˜äº†ï¼Œç»“æŸäº†ã€‚
    if (networkRequest == null) {
      return cacheResponse.newBuilder()
          .cacheResponse(stripBody(cacheResponse))
          .build();
    }

	//åˆ°è¿™é‡Œï¼ŒnetworkRequest != null ï¼ˆcacheResponseå¯èƒ½nullï¼Œä¹Ÿå¯èƒ½!nullï¼‰
	//networkRequest != nullï¼Œå°±æ˜¯è¦è¿›è¡Œç½‘ç»œè¯·æ±‚äº†ï¼Œæ‰€ä»¥ æ‹¦æˆªå™¨é“¾ å°±ç»§ç»­ å¾€ä¸‹å¤„ç†äº†~
    Response networkResponse = null;
    try {
      networkResponse = chain.proceed(networkRequest);
    } finally {
      // If we're crashing on I/O or otherwise, don't leak the cache body.
      if (networkResponse == null && cacheCandidate != null) {
        closeQuietly(cacheCandidate.body());
      }
    }

    // å¦‚æœç½‘ç»œè¯·æ±‚è¿”å›304ï¼Œè¡¨ç¤ºæœåŠ¡ç«¯èµ„æºæ²¡æœ‰ä¿®æ”¹ï¼Œé‚£ä¹ˆå°± ç»“åˆ ç½‘ç»œå“åº”å’Œç¼“å­˜å“åº”ï¼Œç„¶åæ›´æ–°ç¼“å­˜ï¼Œè¿”å›ï¼Œç»“æŸã€‚
    if (cacheResponse != null) {
      if (networkResponse.code() == HTTP_NOT_MODIFIED) {
        Response response = cacheResponse.newBuilder()
            .headers(combine(cacheResponse.headers(), networkResponse.headers()))//ç»“åˆheader
            .sentRequestAtMillis(networkResponse.sentRequestAtMillis())//è¯·æ±‚äº‹ä»¶
            .receivedResponseAtMillis(networkResponse.receivedResponseAtMillis())//æ¥å—äº‹ä»¶
            .cacheResponse(stripBody(cacheResponse))
            .networkResponse(stripBody(networkResponse))
            .build();
        networkResponse.body().close();

        // Update the cache after combining headers but before stripping the
        // Content-Encoding header (as performed by initContentStream()).
        cache.trackConditionalCacheHit();
        cache.update(cacheResponse, response);
        return response;
      } else {
      	//å¦‚æœæ˜¯é304ï¼Œè¯´æ˜æœåŠ¡ç«¯èµ„æºæœ‰æ›´æ–°ï¼Œå°±å…³é—­ç¼“å­˜body
        closeQuietly(cacheResponse.body());
      }
    }

    Response response = networkResponse.newBuilder()
        .cacheResponse(stripBody(cacheResponse))
        .networkResponse(stripBody(networkResponse))
        .build();

    if (cache != null) {
      //ç½‘ç»œå“åº”å¯ç¼“å­˜ï¼ˆè¯·æ±‚å’Œå“åº”çš„ å¤´ Cache-Controléƒ½ä¸æ˜¯'no-store'ï¼‰
      if (HttpHeaders.hasBody(response) && CacheStrategy.isCacheable(response, networkRequest)) {
        // å†™å…¥ç¼“å­˜
        CacheRequest cacheRequest = cache.put(response);
        return cacheWritingResponse(cacheRequest, response);
      }
      
	  //OkHttpé»˜è®¤åªä¼šå¯¹getè¯·æ±‚è¿›è¡Œç¼“å­˜ï¼Œå› ä¸ºgetè¯·æ±‚çš„æ•°æ®ä¸€èˆ¬æ˜¯æ¯”è¾ƒæŒä¹…çš„ï¼Œè€Œpostä¸€èˆ¬æ˜¯äº¤äº’æ“ä½œï¼Œæ²¡å¤ªå¤§æ„ä¹‰è¿›è¡Œç¼“å­˜
	  //ä¸æ˜¯getè¯·æ±‚å°±ç§»é™¤ç¼“å­˜
      if (HttpMethod.invalidatesCache(networkRequest.method())) {
        try {
          cache.remove(networkRequest);
        } catch (IOException ignored) {
          // The cache cannot be written.
        }
      }
    }

    return response;
  }
```
æ•´ä½“æ€è·¯å¾ˆæ¸…æ™°ï¼šä½¿ç”¨ç¼“å­˜ç­–ç•¥`CacheStrategy` æ¥ å†³å®šæ˜¯å¦ä½¿ç”¨ç¼“å­˜ åŠå¦‚ä½•ä½¿ç”¨ã€‚
`CacheStrategy`æ˜¯å¦‚ä½•è·å–çš„ï¼Œè¿™é‡Œå…ˆä¸çœ‹ã€‚éœ€è¦çŸ¥é“ï¼š`strategy.networkRequest`ä¸º`null`ï¼Œä¸ä½¿ç”¨ç½‘ç»œï¼›`strategy.cacheResponse`ä¸º`null`ï¼Œä¸ä½¿ç”¨ç¼“å­˜ã€‚

é‚£ä¹ˆæŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä¸€ç³»åˆ—çš„åˆ¤æ–­ï¼š

1. è‹¥ `networkRequest`ã€`cacheResponse` éƒ½ä¸º`null`ï¼Œå³ç½‘ç»œè¯·æ±‚ã€ç¼“å­˜ éƒ½ä¸èƒ½ç”¨ï¼Œå°±è¿”å›`504`

2. è‹¥ `networkRequest`ä¸º`null`ï¼Œ`cacheResponse`ä¸ä¸º`null`ï¼Œé‚£ä¹ˆå°±æ˜¯ ä¸ç”¨ç½‘ç»œï¼Œä½¿ç”¨ç¼“å­˜äº†ï¼Œå°±ç»“æŸäº†

3. è‹¥ `networkResponse`ä¸ä¸º`null`ï¼Œä¸ç®¡`cacheResponse`æ˜¯å¦`null`ï¼Œéƒ½ä¼šå»è¯·æ±‚ç½‘ç»œï¼Œè·å–ç½‘ç»œå“åº”`networkResponse`

4. æ¥ç€3ï¼Œè‹¥`cacheResponse`ä¸ä¸º`null`ï¼Œä¸”`networkResponse.code`æ˜¯`304`ï¼Œè¡¨ç¤ºæœåŠ¡ç«¯èµ„æºæœªä¿®æ”¹ï¼Œç¼“å­˜æ˜¯è¿˜æœ‰æ•ˆçš„ï¼Œé‚£ä¹ˆç»“åˆ ç½‘ç»œå“åº”å’Œç¼“å­˜å“åº”ï¼Œç„¶åæ›´æ–°ç¼“å­˜ï¼Œç»“æŸ~

5. æ¥ç€3ï¼Œè‹¥`cacheResponse`ä¸º`null`  æˆ– `cacheResponse`ä¸ä¸º`null`ä½†`networkResponse.code`ä¸æ˜¯`304`ï¼Œé‚£ä¹ˆå°±å†™å…¥ç¼“å­˜ï¼Œè¿”å›å“åº”ï¼Œç»“æŸ~


ç»§ç»­çœ‹ï¼Œä¸Šé¢åˆ¤æ–­é€»è¾‘éƒ½æ˜¯åŸºäºCacheStrategyï¼Œè¿™é‡Œæˆ‘ä»¬å°±å»çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Œçœ‹èµ·æ¥å°±æ˜¯ä¸€è¡Œä»£ç ï¼š
```java
    CacheStrategy strategy = new CacheStrategy.Factory(now, chain.request(), cacheCandidate).get();
```
æŠŠè¯·æ±‚`request`ã€å€™é€‰ç¼“å­˜`cacheCandidate`ä¼ å…¥ å·¥å‚ç±»`Factory`ï¼Œç„¶åè°ƒç”¨`get`æ–¹æ³•ï¼Œé‚£ä¹ˆå°±çœ‹ä¸‹å§ï¼š
```java
    public Factory(long nowMillis, Request request, Response cacheResponse) {
      this.nowMillis = nowMillis;
      this.request = request;
      this.cacheResponse = cacheResponse;

      if (cacheResponse != null) {
      	//è·å–å€™é€‰ç¼“å­˜çš„è¯·æ±‚æ—¶é—´ã€å“åº”æ—¶é—´ï¼Œä»headerä¸­è·å– è¿‡æœŸæ—¶é—´ã€ä¿®æ”¹æ—¶é—´ã€èµ„æºæ ‡è®°ç­‰ï¼ˆå¦‚æœæœ‰ï¼‰ã€‚
        this.sentRequestMillis = cacheResponse.sentRequestAtMillis();
        this.receivedResponseMillis = cacheResponse.receivedResponseAtMillis();
        Headers headers = cacheResponse.headers();
        for (int i = 0, size = headers.size(); i < size; i++) {
          String fieldName = headers.name(i);
          String value = headers.value(i);
          if ("Date".equalsIgnoreCase(fieldName)) {
            servedDate = HttpDate.parse(value);
            servedDateString = value;
          } else if ("Expires".equalsIgnoreCase(fieldName)) {
            expires = HttpDate.parse(value);
          } else if ("Last-Modified".equalsIgnoreCase(fieldName)) {
            lastModified = HttpDate.parse(value);
            lastModifiedString = value;
          } else if ("ETag".equalsIgnoreCase(fieldName)) {
            etag = value;
          } else if ("Age".equalsIgnoreCase(fieldName)) {
            ageSeconds = HttpHeaders.parseSeconds(value, -1);
          }
        }
      }
    }

    public CacheStrategy get() {
      CacheStrategy candidate = getCandidate();

      if (candidate.networkRequest != null && request.cacheControl().onlyIfCached()) {
        // We're forbidden from using the network and the cache is insufficient.
        return new CacheStrategy(null, null);
      }

      return candidate;
    }
```
`Factory`çš„æ„é€ æ–¹æ³•å†…ï¼Œè·å–äº†å€™é€‰å“åº”çš„è¯·æ±‚æ—¶é—´ã€å“åº”æ—¶é—´ã€è¿‡æœŸæ—¶é•¿ã€ä¿®æ”¹æ—¶é—´ã€èµ„æºæ ‡è®°ç­‰ã€‚
`get`æ–¹æ³•å†…éƒ¨å…ˆè°ƒç”¨äº†`getCandidate()`è·å–åˆ°ç¼“å­˜ç­–ç•¥å®ä¾‹ï¼Œ å…ˆè·Ÿè¿›åˆ° `getCandidate`æ–¹æ³•çœ‹çœ‹å§ï¼š
```java
    private CacheStrategy getCandidate() {
      // æ²¡æœ‰ç¼“å­˜ï¼šç½‘ç»œè¯·æ±‚
      if (cacheResponse == null) {
        return new CacheStrategy(request, null);
      }

      // httpsï¼Œä½†æ²¡æœ‰æ¡æ‰‹ï¼šç½‘ç»œè¯·æ±‚
      if (request.isHttps() && cacheResponse.handshake() == null) {
        return new CacheStrategy(request, null);
      }

      //ç½‘ç»œå“åº” ä¸å¯ç¼“å­˜ï¼ˆè¯·æ±‚æˆ–å“åº”çš„ å¤´ Cache-Control æ˜¯'no-store'ï¼‰ï¼šç½‘ç»œè¯·æ±‚
      if (!isCacheable(cacheResponse, request)) {
        return new CacheStrategy(request, null);
      }
	  //è¯·æ±‚å¤´çš„Cache-Controlæ˜¯no-cache æˆ–è€… è¯·æ±‚å¤´æœ‰"If-Modified-Since"æˆ–"If-None-Match"ï¼šç½‘ç»œè¯·æ±‚
	  //æ„æ€å°±æ˜¯ ä¸ä½¿ç”¨ç¼“å­˜ æˆ–è€… è¯·æ±‚ æ‰‹åŠ¨ æ·»åŠ äº†å¤´éƒ¨ "If-Modified-Since"æˆ–"If-None-Match"
      CacheControl requestCaching = request.cacheControl();
      if (requestCaching.noCache() || hasConditions(request)) {
        return new CacheStrategy(request, null);
      }

      CacheControl responseCaching = cacheResponse.cacheControl();

	   //ç¼“å­˜çš„å¹´é¾„
      long ageMillis = cacheResponseAge();
      //ç¼“å­˜çš„æœ‰æ•ˆæœŸ
      long freshMillis = computeFreshnessLifetime();
	  //æ¯”è¾ƒè¯·æ±‚å¤´é‡Œæœ‰æ•ˆæœŸï¼Œå–è¾ƒå°å€¼
      if (requestCaching.maxAgeSeconds() != -1) {
        freshMillis = Math.min(freshMillis, SECONDS.toMillis(requestCaching.maxAgeSeconds()));
      }

	  //å¯æ¥å—çš„æœ€å° å‰©ä½™æœ‰æ•ˆæ—¶é—´ï¼ˆmin-freshæ ‡ç¤ºäº†å®¢æˆ·ç«¯ä¸æ„¿æ„æ¥å— å‰©ä½™æœ‰æ•ˆæœŸ<=min-fresh çš„ç¼“å­˜ã€‚ï¼‰
      long minFreshMillis = 0;
      if (requestCaching.minFreshSeconds() != -1) {
        minFreshMillis = SECONDS.toMillis(requestCaching.minFreshSeconds());
      }
	  //å¯æ¥å—çš„æœ€å¤§è¿‡æœŸæ—¶é—´ï¼ˆmax-staleæŒ‡ä»¤æ ‡ç¤ºäº†å®¢æˆ·ç«¯æ„¿æ„æ¥æ”¶ä¸€ä¸ªå·²ç»è¿‡æœŸäº†çš„ç¼“å­˜ï¼Œä¾‹å¦‚ è¿‡æœŸäº† 1å°æ—¶ è¿˜å¯ä»¥ç”¨ï¼‰
      long maxStaleMillis = 0;
      if (!responseCaching.mustRevalidate() && requestCaching.maxStaleSeconds() != -1) {
      		// ç¬¬ä¸€ä¸ªåˆ¤æ–­ï¼šæ˜¯å¦è¦æ±‚å¿…é¡»å»æœåŠ¡å™¨éªŒè¯èµ„æºçŠ¶æ€
      		// ç¬¬äºŒä¸ªåˆ¤æ–­ï¼šè·å–max-staleå€¼ï¼Œå¦‚æœä¸ç­‰äº-1ï¼Œè¯´æ˜ç¼“å­˜è¿‡æœŸåè¿˜èƒ½ä½¿ç”¨æŒ‡å®šçš„æ—¶é•¿
        maxStaleMillis = SECONDS.toMillis(requestCaching.maxStaleSeconds());
      }
      
	  //å¦‚æœå“åº”å¤´æ²¡æœ‰è¦æ±‚å¿½ç•¥æœ¬åœ°ç¼“å­˜ ä¸” æ•´åˆåçš„ç¼“å­˜å¹´é¾„ å°äº æ•´åˆåçš„è¿‡æœŸæ—¶é—´ï¼Œé‚£ä¹ˆç¼“å­˜å°±å¯ä»¥ç”¨
      if (!responseCaching.noCache() && ageMillis + minFreshMillis < freshMillis + maxStaleMillis) {
        Response.Builder builder = cacheResponse.newBuilder();
        //æ²¡æœ‰æ»¡è¶³â€œå¯æ¥å—çš„æœ€å° å‰©ä½™æœ‰æ•ˆæ—¶é—´â€ï¼ŒåŠ ä¸ª110è­¦å‘Š
        if (ageMillis + minFreshMillis >= freshMillis) {
          builder.addHeader("Warning", "110 HttpURLConnection \"Response is stale\"");
        }
        //isFreshnessLifetimeHeuristicè¡¨ç¤ºæ²¡æœ‰è¿‡æœŸæ—¶é—´ï¼Œé‚£ä¹ˆå¤§äºä¸€å¤©ï¼Œå°±åŠ ä¸ª113è­¦å‘Š
        long oneDayMillis = 24 * 60 * 60 * 1000L;
        if (ageMillis > oneDayMillis && isFreshnessLifetimeHeuristic()) {
          builder.addHeader("Warning", "113 HttpURLConnection \"Heuristic expiration\"");
        }
        
        return new CacheStrategy(null, builder.build());
      }

      //åˆ°è¿™é‡Œï¼Œè¯´æ˜ç¼“å­˜æ˜¯è¿‡æœŸçš„
      // ç„¶å æ‰¾ç¼“å­˜é‡Œçš„Etagã€lastModifiedã€servedDate
      String conditionName;
      String conditionValue;
      if (etag != null) {
        conditionName = "If-None-Match";
        conditionValue = etag;
      } else if (lastModified != null) {
        conditionName = "If-Modified-Since";
        conditionValue = lastModifiedString;
      } else if (servedDate != null) {
        conditionName = "If-Modified-Since";
        conditionValue = servedDateString;
      } else {
      	//éƒ½æ²¡æœ‰ï¼Œå°±æ‰§è¡Œå¸¸è§„çš„ç½‘ç»œè¯·æ±‚
        return new CacheStrategy(request, null); // No condition! Make a regular request.
      }

	  //å¦‚æœæœ‰ï¼Œå°±æ·»åŠ åˆ°ç½‘ç»œè¯·æ±‚çš„å¤´éƒ¨ã€‚
      Headers.Builder conditionalRequestHeaders = request.headers().newBuilder();
      Internal.instance.addLenient(conditionalRequestHeaders, conditionName, conditionValue);

      Request conditionalRequest = request.newBuilder()
          .headers(conditionalRequestHeaders.build())
          .build();
          
      //conditionalRequestè¡¨ç¤º æ¡ä»¶ç½‘ç»œè¯·æ±‚ï¼š æœ‰ç¼“å­˜ä½†è¿‡æœŸäº†ï¼Œå»è¯·æ±‚ç½‘ç»œ è¯¢é—®æœåŠ¡ç«¯ï¼Œè¿˜èƒ½ä¸èƒ½ç”¨ã€‚èƒ½ç”¨ä¾§è¿”å›304ï¼Œä¸èƒ½åˆ™æ­£å¸¸æ‰§è¡Œç½‘è·¯è¯·æ±‚ã€‚
      return new CacheStrategy(conditionalRequest, cacheResponse);
    }
```
åŒæ ·æ˜¯è¿›è¿‡ä¸€äº›åˆ—çš„åˆ¤æ–­ï¼š
1. ç¼“å­˜ã€æ˜¯httpsä½†æ²¡æœ‰æ¡æ‰‹ã€è¦æ±‚ä¸å¯ç¼“å­˜ã€å¿½ç•¥ç¼“å­˜æˆ–æ‰‹åŠ¨é…ç½®ç¼“å­˜è¿‡æœŸï¼Œéƒ½æ˜¯ ç›´æ¥è¿›è¡Œ ç½‘ç»œè¯·æ±‚ã€‚

2. ä»¥ä¸Šéƒ½ä¸æ»¡è¶³æ—¶ï¼Œå¦‚æœç¼“å­˜æ²¡è¿‡æœŸï¼Œé‚£ä¹ˆå°±æ˜¯ç”¨ç¼“å­˜ï¼ˆå¯èƒ½è¦æ·»åŠ è­¦å‘Šï¼‰ã€‚

3. å¦‚æœç¼“å­˜è¿‡æœŸäº†ï¼Œä½†å“åº”å¤´æœ‰Etagï¼ŒLast-Modifiedï¼ŒDateï¼Œå°±æ·»åŠ è¿™äº›header è¿›è¡Œæ¡ä»¶ç½‘ç»œè¯·æ±‚ã€‚
4. å¦‚æœç¼“å­˜è¿‡æœŸäº†ï¼Œä¸”å“åº”å¤´æ²¡æœ‰è®¾ç½®Etagï¼ŒLast-Modifiedï¼ŒDateï¼Œå°±è¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚

æ¥ç€å›å¤´çœ‹get()æ–¹æ³•ï¼š
```java
    public CacheStrategy get() {
      CacheStrategy candidate = getCandidate();
      if (candidate.networkRequest != null && request.cacheControl().onlyIfCached()) {
        // We're forbidden from using the network and the cache is insufficient.
        return new CacheStrategy(null, null);
      }
      return candidate;
    }
```
`getCandidate()`è·å–çš„ç¼“å­˜ç­–ç•¥å€™é€‰åï¼Œåˆè¿›è¡Œäº†ä¸€ä¸ªåˆ¤æ–­ï¼šä½¿ç”¨ç½‘ç»œè¯·æ±‚ ä½†æ˜¯ åŸè¯·æ±‚é…ç½®äº†åªèƒ½ä½¿ç”¨ç¼“å­˜ï¼ŒæŒ‰ç…§ä¸Šé¢çš„åˆ†æï¼Œæ­¤æ—¶å³ä½¿æœ‰ç¼“å­˜ï¼Œä¹Ÿæ˜¯è¿‡æœŸçš„ç¼“å­˜ï¼Œæ‰€ä»¥åˆ`new`äº†å®ä¾‹ï¼Œä¸¤ä¸ªå€¼éƒ½ä¸º`null`ã€‚

å¥½äº†ï¼Œåˆ°è¿™é‡Œ`okhttp`çš„ç¼“å­˜æœºåˆ¶æºç å°±çœ‹å®Œäº†ã€‚ä½ ä¼šå‘ç°ï¼Œ`okhttp`çš„ç¼“å­˜æœºåˆ¶ æ˜¯ç¬¦åˆ å¼€å¤´ `http`çš„ç¼“å­˜æœºåˆ¶ é‚£ä¸¤å¼ å›¾çš„ï¼Œåªæ˜¯å¢åŠ å¾ˆå¤šç»†èŠ‚åˆ¤æ–­ã€‚
å¦å¤–ï¼Œæ³¨æ„åˆ°ï¼Œç¼“å­˜çš„è¯»å†™æ˜¯é€šè¿‡ `InternalCache`å®Œæˆçš„ã€‚`InternalCache`æ˜¯åœ¨åˆ›å»º`CacheInterceptor`å®ä¾‹æ—¶ ç”¨`client.internalCache()`ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚è€Œ`InternalCache`æ˜¯`okhttp`å†…éƒ¨ä½¿ç”¨ï¼Œç±»ä¼¼ä¸€ä¸ªä»£ç†ï¼Œ`InternalCache`çš„å®ä¾‹æ˜¯ ç±»`Cache`çš„å±æ€§ã€‚`Cache`æ˜¯æˆ‘ä»¬åˆå§‹åŒ–`OkHttpClient`æ—¶ä¼ å…¥çš„ã€‚æ‰€ä»¥å¦‚æœæ²¡æœ‰ä¼ å…¥`Cache`å®ä¾‹æ˜¯æ²¡æœ‰ç¼“å­˜åŠŸèƒ½çš„ã€‚
```java
        OkHttpClient client = new OkHttpClient.Builder()
                .cache(new Cache(getExternalCacheDir(),500 * 1024 * 1024))
                .build();
```
ç¼“å­˜çš„å¢åˆ æ”¹æŸ¥ï¼Œ`Cache`æ˜¯é€šè¿‡`okhttp`å†…éƒ¨çš„`DiskLruCache`å®ç°çš„ï¼ŒåŸç†å’Œ`jakewharton`çš„`DiskLruCache`æ˜¯ä¸€è‡´çš„ï¼Œè¿™é‡Œå°±ä¸å†å™è¿°ï¼Œè¿™ä¸æ˜¯æœ¬æ–‡é‡ç‚¹ã€‚
æ€»ç»“

å¥½äº†ï¼Œè¿™ç¯‡æ–‡ç« åˆ°è¿™é‡Œå†…å®¹è®²å®Œäº†ï¼Œè¿˜æ˜¯æŒºä¸°å¯Œçš„ã€‚è®²è§£äº†ä¸‰ä¸ªæ‹¦æˆªå™¨çš„å·¥ä½œåŸç†ï¼š`RetryAndFollowUpInterceptor`ã€`BridgeInterceptor`ã€`CacheInterceptor`ï¼Œå…¶ä¸­`CacheInterceptor`æ˜¯è¯·æ±‚ç¼“å­˜å¤„ç†ï¼Œæ˜¯æ¯”è¾ƒé‡è¦çš„çŸ¥è¯†ç‚¹ã€‚ç›®å‰ä¸ºæ­¢ï¼Œè¿˜æ²¡æœ‰çœ‹åˆ°çœŸæ­£çš„ç½‘ç»œè¿æ¥å’Œè¯·æ±‚å“åº”è¯»å†™ï¼Œè¿™äº›å†…å®¹ä¼šåœ¨ä¸‹ä¸€ç¯‡è®²è§£ â€” å‰©ä¸‹çš„ä¸¤ä¸ªæ‹¦æˆªå™¨ ï¼š`ConnectInterceptor`ã€`CallServerInterceptor`ã€‚ï¼ˆä¸ç„¶å°±å¤ªé•¿äº†ğŸ˜ï¼‰

```java
ä½œè€…ï¼šèƒ¡é£æ´‹
é“¾æ¥ï¼šhttps://juejin.cn/post/6844904176183410702
æ¥æºï¼šç¨€åœŸæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚
```