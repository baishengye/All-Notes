## æ‹¦æˆªå™¨è¯¦è§£2ï¼šè¿æ¥ã€è¯·æ±‚æœåŠ¡ï¼ˆé‡ç‚¹ï¼‰

### 1. èƒŒæ™¯ - HTTPåè®®å‘å±•
åœ¨è®²è§£æ‹¦æˆªå™¨ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦äº†è§£httpåè®®ç›¸å…³èƒŒæ™¯çŸ¥è¯†ï¼Œå› ä¸ºokhttpçš„ç½‘ç»œè¿æ¥æ­£æ˜¯åŸºäºæ­¤å®ç°çš„ã€‚HTTPåè®®ç»å†äº†ä»¥ä¸‹ä¸‰ä¸ªç‰ˆæœ¬é˜¶æ®µã€‚

#### 1.0 HTTP1.0
åœ¨**HTTP1.0**ä¸­ï¼Œä¸€æ¬¡è¯·æ±‚ ä¼šå»ºç«‹ä¸€ä¸ªTCPè¿æ¥ï¼Œè¯·æ±‚å®Œæˆåä¸»åŠ¨æ–­å¼€è¿æ¥ã€‚è¿™ç§æ–¹æ³•çš„å¥½å¤„æ˜¯ç®€å•ï¼Œå„ä¸ªè¯·æ±‚äº’ä¸å¹²æ‰°ã€‚
ä½†æ¯æ¬¡è¯·æ±‚éƒ½ä¼šç»å† **3æ¬¡æ¡æ‰‹ã€2æ¬¡æˆ–4æ¬¡æŒ¥æ‰‹**çš„è¿æ¥å»ºç«‹å’Œæ–­å¼€è¿‡ç¨‹â€”â€”æå¤§å½±å“ç½‘ç»œæ•ˆç‡å’Œç³»ç»Ÿå¼€é”€ã€‚
![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/6/14/172b2ffdbb5b8e68~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)

#### 1.1 HTTP1.1
åœ¨**HTTP1.1**ä¸­ï¼Œè§£å†³äº†HTTP1.0ä¸­è¿æ¥ä¸èƒ½å¤ç”¨çš„é—®é¢˜ï¼Œæ”¯æŒæŒä¹…è¿æ¥â€”â€”ä½¿ç”¨keep-aliveæœºåˆ¶ï¼šä¸€æ¬¡HTTPè¯·æ±‚ç»“æŸåä¸ä¼šç«‹å³æ–­å¼€TCPè¿æ¥ï¼Œå¦‚æœæ­¤æ—¶æœ‰æ–°çš„HTTPè¯·æ±‚ï¼Œä¸”å…¶è¯·æ±‚çš„HoståŒä¸Šæ¬¡è¯·æ±‚ç›¸åŒï¼Œé‚£ä¹ˆä¼šç›´æ¥å¤ç”¨TCPè¿æ¥ã€‚è¿™æ ·å°±å‡å°‘äº†å»ºç«‹å’Œå…³é—­è¿æ¥çš„æ¶ˆè€—å’Œå»¶è¿Ÿã€‚**keep-aliveæœºåˆ¶**åœ¨HTTP1.1ä¸­æ˜¯é»˜è®¤æ‰“å¼€çš„â€”â€”å³åœ¨è¯·æ±‚å¤´æ·»åŠ ï¼š**connection:keep-alive**ã€‚ï¼ˆkeep-aliveä¸ä¼šæ°¸ä¹…ä¿æŒè¿æ¥ï¼Œå®ƒæœ‰ä¸€ä¸ªä¿æŒæ—¶é—´ï¼Œå¯åœ¨ä¸åŒçš„æœåŠ¡å™¨è½¯ä»¶ï¼ˆå¦‚Apacheï¼‰ä¸­è®¾å®šè¿™ä¸ªæ—¶é—´ï¼‰
![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/6/14/172b2ffdbb61a3ff~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)

#### 1.2 HTTP2.0
HTTP1.1ä¸­ï¼Œ**è¿æ¥çš„å¤ç”¨æ˜¯ä¸²è¡Œ**çš„ï¼šä¸€ä¸ªè¯·æ±‚å»ºç«‹äº†TCPè¿æ¥ï¼Œè¯·æ±‚å®Œæˆåï¼Œä¸‹ä¸€ä¸ªç›¸åŒhostçš„è¯·æ±‚ç»§ç»­ä½¿ç”¨è¿™ä¸ªè¿æ¥ã€‚ ä½†å®¢æˆ·ç«¯æƒ³ **åŒæ—¶** å‘èµ·å¤šä¸ª**å¹¶è¡Œè¯·æ±‚**ï¼Œé‚£ä¹ˆå¿…é¡»å»ºç«‹**å¤šä¸ªTCPè¿æ¥**ã€‚å°†ä¼šäº§ç”Ÿç½‘ç»œå»¶è¿Ÿã€å¢å¤§ç½‘è·¯å¼€é”€ã€‚
å¹¶ä¸”HTTP1.1ä¸ä¼šå‹ç¼©è¯·æ±‚å’Œå“åº”æŠ¥å¤´ï¼Œå¯¼è‡´äº†ä¸å¿…è¦çš„ç½‘ç»œæµé‡ï¼›HTTP1.1ä¸æ”¯æŒèµ„æºä¼˜å…ˆçº§å¯¼è‡´åº•å±‚TCPè¿æ¥åˆ©ç”¨ç‡ä½ä¸‹ã€‚åœ¨HTTP2.0ä¸­ï¼Œè¿™äº›é—®é¢˜éƒ½ä¼šå¾—åˆ°è§£å†³ï¼Œ**HTTP2.0**ä¸»è¦æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š
>
>- **æ–°çš„äºŒè¿›åˆ¶æ ¼å¼ï¼ˆBinary Formatï¼‰**ï¼šhttp/1.xä½¿ç”¨çš„æ˜¯æ˜æ–‡åè®®ï¼Œå…¶åè®®æ ¼å¼ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼šrequest lineï¼Œheaderï¼Œbodyï¼Œå…¶åè®®è§£ææ˜¯åŸºäºæ–‡æœ¬ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼å­˜åœ¨å¤©ç„¶ç¼ºé™·ï¼Œæ–‡æœ¬çš„è¡¨ç°å½¢å¼æœ‰å¤šæ ·æ€§ï¼Œè¦åšåˆ°å¥å£®æ€§è€ƒè™‘çš„åœºæ™¯å¿…ç„¶å¾ˆå¤šï¼ŒäºŒè¿›åˆ¶åˆ™ä¸åŒï¼Œåªè®¤0å’Œ1çš„ç»„åˆï¼›åŸºäºè¿™ç§è€ƒè™‘ï¼Œhttp/2.0çš„åè®®è§£æå†³å®šé‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼ï¼Œå®ç°æ–¹ä¾¿ä¸”å¥å£®
>- **å¤šè·¯å¤ç”¨ï¼ˆMultiPlexingï¼‰**ï¼šå³è¿æ¥å…±äº«ï¼Œä½¿ç”¨streamIdç”¨æ¥åŒºåˆ†è¯·æ±‚ï¼Œä¸€ä¸ªrequestå¯¹åº”ä¸€ä¸ªstreamå¹¶åˆ†é…ä¸€ä¸ªidï¼Œè¿™æ ·ä¸€ä¸ªTCPè¿æ¥ä¸Šå¯ä»¥æœ‰å¤šä¸ªstreamï¼Œæ¯ä¸ªstreamçš„frameå¯ä»¥éšæœºçš„æ··æ‚åœ¨ä¸€èµ·ï¼Œæ¥æ”¶æ–¹å¯ä»¥æ ¹æ®stream idå°†frameå†å½’å±åˆ°å„è‡ªä¸åŒçš„requesté‡Œé¢
>- **ä¼˜å…ˆçº§å’Œä¾èµ–ï¼ˆPriorityã€Dependencyï¼‰**ï¼šæ¯ä¸ªstreaméƒ½å¯ä»¥è®¾ç½®ä¼˜å…ˆçº§å’Œä¾èµ–ï¼Œä¼˜å…ˆçº§é«˜çš„streamä¼šè¢«serverä¼˜å…ˆå¤„ç†å’Œè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œstreamè¿˜å¯ä»¥ä¾èµ–å…¶å®ƒçš„sub streamsï¼›ä¼˜å…ˆçº§å’Œä¾èµ–éƒ½æ˜¯å¯ä»¥åŠ¨æ€è°ƒæ•´çš„ï¼Œæ¯”å¦‚åœ¨APPä¸Šæµè§ˆå•†å“åˆ—è¡¨ï¼Œç”¨æˆ·å¿«é€Ÿæ»‘åŠ¨åˆ°åº•éƒ¨ï¼Œä½†æ˜¯å‰é¢çš„è¯·æ±‚å·²ç»å‘å‡ºï¼Œå¦‚æœä¸æŠŠåé¢çš„ä¼˜å…ˆçº§è®¾é«˜ï¼Œé‚£ä¹ˆå½“å‰æµè§ˆçš„å›¾ç‰‡å°†ä¼šåœ¨æœ€åå±•ç¤ºå‡ºæ¥ï¼Œæ˜¾ç„¶ä¸åˆ©äºç”¨æˆ·ä½“éªŒ
>- **headerå‹ç¼©**ï¼šhttp2.0ä½¿ç”¨encoderæ¥å‡å°‘éœ€è¦ä¼ è¾“çš„headerå¤§å°ï¼Œé€šè®¯åŒæ–¹å„è‡ªcacheä¸€ä»½header fieldsè¡¨ï¼Œæ—¢é¿å…äº†é‡å¤headerçš„ä¼ è¾“ï¼Œåˆå‡å°äº†éœ€è¦ä¼ è¾“çš„å¤§å°
>- **é‡ç½®è¿æ¥**ï¼šå¾ˆå¤šAPPé‡Œéƒ½æœ‰åœæ­¢ä¸‹è½½å›¾ç‰‡çš„éœ€æ±‚ï¼Œå¯¹äºhttp1.xæ¥è¯´ï¼Œæ˜¯ç›´æ¥æ–­å¼€è¿æ¥ï¼Œå¯¼è‡´ä¸‹æ¬¡å†å‘è¯·æ±‚å¿…é¡»é‡æ–°å»ºç«‹è¿æ¥ï¼›http2.0å¼•å…¥RST_STREAMç±»å‹çš„frameï¼Œå¯ä»¥åœ¨ä¸æ–­å¼€è¿æ¥çš„å‰æä¸‹å–æ¶ˆæŸä¸ªrequestçš„stream


å…¶ä¸­æ¶‰åŠäº†ä¸¤ä¸ªæ–°çš„æ¦‚å¿µï¼š

- **æ•°æ®æµ-stream**ï¼šåŸºäºTCPè¿æ¥ä¹‹ä¸Šçš„é€»è¾‘åŒå‘å­—èŠ‚æµï¼Œç”¨äºæ‰¿è½½åŒå‘æ¶ˆæ¯ï¼Œå¯¹åº”ä¸€ä¸ªè¯·æ±‚åŠå…¶å“åº”ã€‚å®¢æˆ·ç«¯æ¯å‘èµ·ä¸€ä¸ªè¯·æ±‚å°±å»ºç«‹ä¸€ä¸ªæ•°æ®æµï¼Œåç»­è¯¥è¯·æ±‚åŠå…¶å“åº”çš„æ‰€æœ‰æ•°æ®éƒ½é€šè¿‡è¯¥æ•°æ®æµä¼ è¾“ã€‚æ¯ä¸ªæ•°æ®æµéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦å’Œå¯é€‰çš„ä¼˜å…ˆçº§ä¿¡æ¯ã€‚
- **å¸§-frame**ï¼šHTTP/2çš„æœ€å°æ•°æ®åˆ‡ç‰‡å•ä½ï¼Œæ‰¿è½½ç€ç‰¹å®šç±»å‹çš„æ•°æ®ï¼Œä¾‹å¦‚ HTTP æ ‡å¤´ã€æ¶ˆæ¯è´Ÿè½½ï¼Œç­‰ç­‰ã€‚ æ¥è‡ªä¸åŒæ•°æ®æµçš„å¸§å¯ä»¥äº¤é”™å‘é€ï¼Œç„¶åå†æ ¹æ®æ¯ä¸ªå¸§å¤´çš„æ•°æ®æµæ ‡è¯†ç¬¦é‡æ–°ç»„è£…ï¼Œä»è€Œåœ¨å®è§‚ä¸Šå®ç°äº†å¤šä¸ªè¯·æ±‚æˆ–å“åº”å¹¶è¡Œä¼ è¾“çš„æ•ˆæœã€‚

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/6/14/172b2ffdbb7beac2~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)

è¿™é‡Œçš„ **å¤šè·¯å¤ç”¨æœºåˆ¶** å°±å®ç°äº† **åœ¨åŒä¸€ä¸ªTCPè¿æ¥ä¸Š å¤šä¸ªè¯·æ±‚ å¹¶è¡Œæ‰§è¡Œ**ã€‚
æ— è®ºæ˜¯HTTP1.1çš„Keep-Aliveæœºåˆ¶è¿˜æ˜¯HTTP2.0çš„å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œåœ¨å®ç°ä¸Šéƒ½éœ€è¦å¼•å…¥è¿æ¥æ± æ¥ç»´æŠ¤ç½‘ç»œè¿æ¥ã€‚

ä¸‹é¢å°±å¼€å§‹åˆ†æ **OkHttpä¸­çš„è¿æ¥æ± å®ç°â€”â€”è¿æ¥æ‹¦æˆªå™¨ConnectInterceptor**ã€‚

### 2. ConnectInterceptor
è¿æ¥æ‹¦æˆªå™¨`ConnectInterceptor`ä»£ç å¦‚ä¸‹ï¼š
```java
//æ‰“å¼€åˆ°ç›®æ ‡æœåŠ¡çš„è¿æ¥ã€å¤„ç†ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨
public final class ConnectInterceptor implements Interceptor {
  public final OkHttpClient client;

  public ConnectInterceptor(OkHttpClient client) {
    this.client = client;
  }

  @Override public Response intercept(Chain chain) throws IOException {
    RealInterceptorChain realChain = (RealInterceptorChain) chain;
    Request request = realChain.request();
    Transmitter transmitter = realChain.transmitter();

    // We need the network to satisfy this request. Possibly for validating a conditional GET.
    boolean doExtensiveHealthChecks = !request.method().equals("GET");
    Exchange exchange = transmitter.newExchange(chain, doExtensiveHealthChecks);

    return realChain.proceed(request, transmitter, exchange);
  }
}
```
ä»£ç å¾ˆå°‘ï¼Œä¸»è¦æ˜¯ä½¿ç”¨`transmitter.newExchange`è·å–`Exchange`å®ä¾‹ï¼Œå¹¶ä½œä¸ºå‚æ•°è°ƒç”¨æ‹¦æˆªå™¨é“¾çš„`proceed`çš„æ–¹æ³•ã€‚æ³¨æ„åˆ°å‰é¢åˆ†æè¿‡çš„æ‹¦æˆªå™¨è°ƒç”¨çš„`proceed`æ–¹æ³•æ˜¯ä¸€ä¸ªå‚æ•°çš„ï¼Œè€Œè¿™é‡Œæ˜¯ä¸‰ä¸ªå‚æ•°çš„ã€‚è¿™æ˜¯å› ä¸ºä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ï¼ˆå¦‚æœæ²¡æœ‰é…ç½®ç½‘ç»œæ‹¦æˆªå™¨çš„è¯ï¼Œå°±æ˜¯`CallServerInterceptor`ï¼Œä¹Ÿæ˜¯æœ€åä¸€ä¸ªï¼‰éœ€è¦è¿›è¡ŒçœŸæ­£çš„ç½‘ç»œ`IO`æ“ä½œï¼Œè€Œ `Exchange`ï¼ˆæ„ä¸ºäº¤æ¢ï¼‰ä¸»è¦ä½œç”¨å°±æ˜¯çœŸæ­£çš„`IO`æ“ä½œï¼šå†™å…¥è¯·æ±‚ã€è¯»å–å“åº”ï¼ˆä¼šåœ¨ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨åšä»‹ç»ï¼‰ã€‚
å®é™…ä¸Šè·å–`Exchange`å®ä¾‹çš„é€»è¾‘å¤„ç†éƒ½å°è£…åœ¨`Transmitter`ä¸­äº†ã€‚å‰é¢çš„æ–‡ç« æåˆ°è¿‡`Transmitter`ï¼Œå®ƒæ˜¯â€œå‘å°„å™¨â€ï¼Œæ˜¯æŠŠ è¯·æ±‚ ä»åº”ç”¨ç«¯ å‘å°„åˆ° ç½‘ç»œå±‚ï¼Œå®ƒæŒæœ‰è¯·æ±‚çš„ è¿æ¥ã€è¯·æ±‚ã€å“åº” å’Œ æµï¼Œä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ª`Transmitter`å®ä¾‹ï¼Œä¸€ä¸ªæ•°æ®æµã€‚ä¸‹é¢å°±çœ‹ä¸‹å®ƒçš„`newExchange`æ–¹æ³•ï¼š
```java
  Exchange newExchange(Interceptor.Chain chain, boolean doExtensiveHealthChecks) {
    synchronized (connectionPool) {
      if (noMoreExchanges) {
        throw new IllegalStateException("released");
      }
      if (exchange != null) {
        throw new IllegalStateException("cannot make a new request because the previous response "
            + "is still open: please call response.close()");
      }
    }

    ExchangeCodec codec = exchangeFinder.find(client, chain, doExtensiveHealthChecks);
    Exchange result = new Exchange(this, call, eventListener, exchangeFinder, codec);

    synchronized (connectionPool) {
      this.exchange = result;
      this.exchangeRequestDone = false;
      this.exchangeResponseDone = false;
      return result;
    }
  }
```
è‹¥æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œå‰é¢ä¸¤ä¸ª`if`æ˜¯æ²¡èµ°è¿›å»çš„ã€‚æ¥ç€çœ‹åˆ°ä½¿ç”¨`exchangeFinder`çš„`find`æ–¹æ³•è·å–åˆ°äº†`ExchangeCodec`å®ä¾‹ï¼Œç„¶åä½œä¸ºå‚æ•°æ„å»ºäº†`Exchange`å®ä¾‹ï¼Œå¹¶è¿”å›ã€‚å—¯ï¼Œçœ‹èµ·æ¥ä¹Ÿå¾ˆç®€å•çš„æ ·å­ã€‚ æ³¨æ„åˆ°è¿™ä¸ªæ–¹æ³•é‡Œæ¶‰åŠäº†è¿æ¥æ± `RealConnectionPool`ã€äº¤æ¢å¯»æ‰¾å™¨`ExchangeFinder`ã€äº¤æ¢ç¼–è§£ç `ExchangeCodec`ã€äº¤æ¢ç®¡ç†`Exchange`è¿™å‡ ä¸ªç±»ï¼ˆç¿»è¯‘æˆè¿™æ ·å°½åŠ›äº†ğŸ˜Šï¼Œæ„ä¼šå§ï¼‰ã€‚

- `RealConnectionPool`ï¼Œè¿æ¥æ± ï¼Œè´Ÿè´£ç®¡ç†è¯·æ±‚çš„è¿æ¥ï¼ŒåŒ…æ‹¬æ–°å»ºã€å¤ç”¨ã€å…³é—­ï¼Œç†è§£ä¸Šç±»ä¼¼çº¿ç¨‹æ± ã€‚
- `ExchangeCodec`ï¼Œæ¥å£ç±»ï¼Œè´Ÿè´£çœŸæ­£çš„IOæ“ä½œâ€”å†™è¯·æ±‚ã€è¯»å“åº”ï¼Œå®ç°ç±»æœ‰Http1ExchangeCodecã€Http2ExchangeCodecï¼Œåˆ†åˆ«å¯¹åº”HTTP1.1åè®®ã€HTTP2.0åè®®ã€‚
- `Exchange`ï¼Œç®¡ç†IOæ“ä½œï¼Œå¯ä»¥ç†è§£ä¸º æ•°æ®æµï¼Œæ˜¯ExchangeCodecçš„åŒ…è£…ï¼Œå¢åŠ äº†äº‹ä»¶å›è°ƒï¼›ä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ªExchangeå®ä¾‹ã€‚ä¼ ç»™ä¸‹ä¸ªæ‹¦æˆªå™¨CallServerInterceptorä½¿ç”¨ã€‚
- `ExchangeFinder`ï¼Œï¼ˆä»è¿æ¥æ± ä¸­ï¼‰å¯»æ‰¾å¯ç”¨TCPè¿æ¥ï¼Œç„¶åé€šè¿‡è¿æ¥å¾—åˆ°ExchangeCodecã€‚

#### 2.1. ExchangeFinder
`ExchangeFinder`çš„ä½œç”¨ä»åå­—å°±å¯ä»¥çœ‹å‡ºâ€”â€”`Exchange`å¯»æ‰¾è€…ï¼Œæœ¬è´¨æ˜¯ä¸ºè¯·æ±‚å¯»æ‰¾ä¸€ä¸ª`TCP`è¿æ¥ã€‚å¦‚æœå·²æœ‰å¯ç”¨è¿æ¥å°±ç›´æ¥ä½¿ç”¨ï¼Œæ²¡æœ‰åˆ™æ‰“å¼€ä¸€ä¸ªæ–°çš„è¿æ¥ã€‚ ä¸€ä¸ªç½‘ç»œè¯·æ±‚çš„æ‰§è¡Œï¼Œéœ€è¦å…ˆæœ‰ä¸€ä¸ªæŒ‡å‘ç›®æ ‡æœåŠ¡çš„`TCP`è¿æ¥ï¼Œç„¶åå†è¿›è¡Œå†™è¯·æ±‚ã€è¯»å“åº”çš„`IO`æ“ä½œã€‚`ExchangeFinder`æ˜¯æ€ä¹ˆå¯»æ‰¾çš„å‘¢ï¼Ÿç»§ç»­å¾€ä¸‹çœ‹~
æˆ‘ä»¬å…ˆçœ‹`exchangeFinder`åˆå§‹åŒ–çš„åœ°æ–¹ï¼š
```java
  public void prepareToConnect(Request request) {
    ...
    this.exchangeFinder = new ExchangeFinder(this, connectionPool, createAddress(request.url()),
        call, eventListener);
  }
```
çœ‹åˆ°è¿™é‡Œåº”è¯¥ä¼šæƒ³èµ·ä¸Šä¸€ç¯‡æ–‡ç« ä¸­åˆ†æ`RetryAndFollowUpInterceptor`æ—¶æåˆ°è¿‡ï¼Œ`prepareToConnect`è¿™ä¸ªæ–¹æ³•ä½œç”¨æ˜¯è¿æ¥å‡†å¤‡ï¼Œå°±æ˜¯åˆ›å»ºäº†`ExchangeFinder`å®ä¾‹ã€‚ä¸»è¦åˆ°ä¼ å…¥çš„å‚æ•°æœ‰`connectionPool`ã€`createAddress`æ–¹æ³•è¿”å›çš„`Address`ã€`call`ã€`eventListener`ã€‚`connectionPool`æ˜¯è¿æ¥æ± ï¼Œç¨ååˆ†æï¼Œå…ˆçœ‹ä¸‹`createAddress`æ–¹æ³•ï¼š
```java
  private Address createAddress(HttpUrl url) {
    SSLSocketFactory sslSocketFactory = null;
    HostnameVerifier hostnameVerifier = null;
    CertificatePinner certificatePinner = null;
    if (url.isHttps()) {
      sslSocketFactory = client.sslSocketFactory();
      hostnameVerifier = client.hostnameVerifier();
      certificatePinner = client.certificatePinner();
    }

    return new Address(url.host(), url.port(), client.dns(), client.socketFactory(),
        sslSocketFactory, hostnameVerifier, certificatePinner, client.proxyAuthenticator(),
        client.proxy(), client.protocols(), client.connectionSpecs(), client.proxySelector());
  }
```
ä½¿ç”¨`url`å’Œ`client`é…ç½® åˆ›å»ºä¸€ä¸ª`Address`å®ä¾‹ã€‚`Address`æ„æ€æ˜¯æŒ‡å‘æœåŠ¡çš„è¿æ¥çš„åœ°å€ï¼Œå¯ä»¥ç†è§£ä¸ºè¯·æ±‚åœ°å€åŠå…¶é…ç½®ã€‚`Address`æœ‰ä¸€ä¸ªé‡è¦ä½œç”¨ï¼šç›¸åŒ`Address`çš„`HTTP`è¯·æ±‚ å…±äº« ç›¸åŒçš„è¿æ¥ã€‚è¿™å¯ä»¥ä½œä¸ºå‰é¢æåˆ°çš„ `HTTP1.1`å’Œ`HTTP2.0` å¤ç”¨è¿æ¥ çš„è¯·æ±‚çš„åˆ¤æ–­ã€‚
å›å¤´çœ‹`exchangeFinder`çš„`find`æ–¹æ³•
```java
  public ExchangeCodec find(
      OkHttpClient client, Interceptor.Chain chain, boolean doExtensiveHealthChecks) {
    int connectTimeout = chain.connectTimeoutMillis();
    int readTimeout = chain.readTimeoutMillis();
    int writeTimeout = chain.writeTimeoutMillis();
    int pingIntervalMillis = client.pingIntervalMillis();
    boolean connectionRetryEnabled = client.retryOnConnectionFailure();

    try {
      //æ‰¾åˆ°ä¸€ä¸ªå¥åº·çš„è¿æ¥
      RealConnection resultConnection = findHealthyConnection(connectTimeout, readTimeout,
          writeTimeout, pingIntervalMillis, connectionRetryEnabled, doExtensiveHealthChecks);
      //åˆ©ç”¨è¿æ¥å®ä¾‹åŒ–ExchangeCodecå¯¹è±¡ï¼Œå¦‚æœæ˜¯HTTP/2è¿”å›Http2ExchangeCodecï¼Œå¦åˆ™è¿”å›Http1ExchangeCodec
      return resultConnection.newCodec(client, chain);
    } catch (RouteException e) {
      trackFailure();
      throw e;
    } catch (IOException e) {
      trackFailure();
      throw new RouteException(e);
    }
  }
```
ä¸»è¦å°±æ˜¯é€šè¿‡`findHealthyConnection`æ–¹æ³•è·å–è¿æ¥`RealConnection`å®ä¾‹ï¼Œç„¶åç”¨`RealConnection`çš„`newCodec`æ–¹æ³•è·å–äº†`ExchangeCodec`å®ä¾‹ï¼Œå¦‚æœæ˜¯`HTTP/2`è¿”å›`Http2ExchangeCodec`ï¼Œå¦åˆ™è¿”å›`Http1ExchangeCodec`ï¼Œç„¶åè¿”å›ã€‚
`findHealthyConnection`æ–¹æ³•åé€éœ²ç€ å°±æ˜¯å»å¯»æ‰¾å¯ç”¨`TCP`è¿æ¥çš„ï¼Œè€Œæˆ‘ä»¬çŒœæµ‹è¿™ä¸ªæ–¹æ³•å†…éƒ¨è‚¯å®šå’Œè¿æ¥æ± `ConnectionPool`æœ‰ç´§å¯†çš„å…³ç³»ã€‚æ¥ç€è·Ÿè¿›`findHealthyConnection`æ–¹æ³•ï¼š
```java
  private RealConnection findHealthyConnection(int connectTimeout, int readTimeout,
      int writeTimeout, int pingIntervalMillis, boolean connectionRetryEnabled,
      boolean doExtensiveHealthChecks) throws IOException {
    while (true) {
      //æ‰¾è¿æ¥
      RealConnection candidate = findConnection(connectTimeout, readTimeout, writeTimeout,
          pingIntervalMillis, connectionRetryEnabled);

      // æ˜¯æ–°è¿æ¥ ä¸”ä¸æ˜¯HTTP2.0 å°±ä¸ç”¨ä½“æ£€
      synchronized (connectionPool) {
        if (candidate.successCount == 0 && !candidate.isMultiplexed()) {
          return candidate;
        }
      }
      // ä½“æ£€ä¸å¥åº·ï¼Œç»§ç»­æ‰¾
      if (!candidate.isHealthy(doExtensiveHealthChecks)) {
      	//æ ‡è®°ä¸å¯ç”¨
        candidate.noNewExchanges();
        continue;
      }

      return candidate;
    }
  }
```
å¾ªç¯å¯»æ‰¾è¿æ¥ï¼šå¦‚æœæ˜¯ä¸å¥åº·çš„è¿æ¥ï¼Œæ ‡è®°ä¸å¯ç”¨ï¼ˆæ ‡è®°åä¼šç§»é™¤ï¼Œåé¢è®²è¿æ¥æ± ä¼šè®²åˆ°ï¼‰ï¼Œç„¶åç»§ç»­æ‰¾ã€‚å¥åº·æ˜¯æŒ‡è¿æ¥å¯ä»¥æ‰¿è½½æ–°çš„æ•°æ®æµï¼Œsocketæ˜¯è¿æ¥çŠ¶æ€ã€‚æˆ‘ä»¬è·Ÿè¿›`findConnection`æ–¹æ³•ï¼Œçœ‹çœ‹åˆ°åº•æ˜¯æ€ä¹ˆ æ‰¾è¿æ¥ çš„ï¼š
```java
  //ä¸ºæ‰¿è½½æ–°çš„æ•°æ®æµ å¯»æ‰¾ è¿æ¥ã€‚å¯»æ‰¾é¡ºåºæ˜¯ å·²åˆ†é…çš„è¿æ¥ã€è¿æ¥æ± ã€æ–°å»ºè¿æ¥
  private RealConnection findConnection(int connectTimeout, int readTimeout, int writeTimeout,
      int pingIntervalMillis, boolean connectionRetryEnabled) throws IOException {
    boolean foundPooledConnection = false;
    RealConnection result = null;
    Route selectedRoute = null;
    RealConnection releasedConnection;
    Socket toClose;
    synchronized (connectionPool) {
      //è¯·æ±‚å·²è¢«å–æ¶ˆï¼ˆCallçš„cancelæ–¹æ³•->transmitterçš„cancelæ–¹æ³•ï¼‰ï¼ŒæŠ›å¼‚å¸¸
      if (transmitter.isCanceled()) throw new IOException("Canceled");
      hasStreamFailure = false; 

      // å°è¯•ä½¿ç”¨ å·²ç»™æ•°æ®æµåˆ†é…çš„è¿æ¥.ï¼ˆä¾‹å¦‚é‡å®šå‘è¯·æ±‚æ—¶ï¼Œå¯ä»¥å¤ç”¨ä¸Šæ¬¡è¯·æ±‚çš„è¿æ¥ï¼‰
      releasedConnection = transmitter.connection;
      //æœ‰å·²åˆ†é…çš„è¿æ¥ï¼Œä½†å·²ç»è¢«é™åˆ¶æ‰¿è½½æ–°çš„æ•°æ®æµï¼Œå°±å°è¯•é‡Šæ”¾æ‰ï¼ˆå¦‚æœè¿æ¥ä¸Šå·²æ²¡æœ‰æ•°æ®æµï¼‰ï¼Œå¹¶è¿”å›å¾…å…³é—­çš„socketã€‚
      toClose = transmitter.connection != null && transmitter.connection.noNewExchanges
          ? transmitter.releaseConnectionNoEvents()
          : null;

      if (transmitter.connection != null) {
        // ä¸ä¸ºç©ºï¼Œè¯´æ˜ä¸Šé¢æ²¡æœ‰é‡Šæ”¾æ‰ï¼Œé‚£ä¹ˆæ­¤è¿æ¥å¯ç”¨
        result = transmitter.connection;
        releasedConnection = null;
      }

      if (result == null) {
        // æ²¡æœ‰å·²åˆ†é…çš„å¯ç”¨è¿æ¥ï¼Œå°±å°è¯•ä»è¿æ¥æ± è·å–ã€‚ï¼ˆè¿æ¥æ± ç¨åè¯¦ç»†è®²è§£ï¼‰
        if (connectionPool.transmitterAcquirePooledConnection(address, transmitter, null, false)) {
          foundPooledConnection = true;
          result = transmitter.connection;
        } else if (nextRouteToTry != null) {
          selectedRoute = nextRouteToTry;//æœ‰å¯å°è¯•çš„è·¯ç”±
          nextRouteToTry = null;
        } else if (retryCurrentRoute()) {
          selectedRoute = transmitter.connection.route();
        }
      }
    }
    closeQuietly(toClose);//ï¼ˆå¦‚æœæœ‰ï¼‰å…³é—­å¾…å…³é—­çš„socket

    if (releasedConnection != null) {
      eventListener.connectionReleased(call, releasedConnection);//ï¼ˆå¦‚æœæœ‰ï¼‰å›è°ƒè¿æ¥é‡Šæ”¾äº‹ä»¶
    }
    if (foundPooledConnection) {
      eventListener.connectionAcquired(call, result);//(å¦‚æœæœ‰ï¼‰å›è°ƒï¼ˆä»è¿æ¥æ± ï¼‰è·å–è¿æ¥äº‹ä»¶
    }
    if (result != null) {
      // å¦‚æœæœ‰å·²åˆ†é…å¯ç”¨è¿æ¥ æˆ– ä»è¿æ¥æ± è·å–åˆ°è¿æ¥ï¼Œç»“æŸï¼  æ²¡æœ‰ å°±èµ°ä¸‹é¢çš„æ–°å»ºè¿æ¥è¿‡ç¨‹ã€‚
      return result;
    }

    // å¦‚æœéœ€è¦è·¯ç”±ä¿¡æ¯ï¼Œå°±è·å–ã€‚æ˜¯é˜»å¡æ“ä½œ
    boolean newRouteSelection = false;
    if (selectedRoute == null && (routeSelection == null || !routeSelection.hasNext())) {
      newRouteSelection = true;
      routeSelection = routeSelector.next();
    }

    List<Route> routes = null;
    synchronized (connectionPool) {
      if (transmitter.isCanceled()) throw new IOException("Canceled");

      if (newRouteSelection) {
        //ç°åœ¨æœ‰äº†IPåœ°å€ï¼Œå†æ¬¡å°è¯•ä»è¿æ¥æ± è·å–ã€‚å¯èƒ½ä¼šå› ä¸ºè¿æ¥åˆå¹¶è€ŒåŒ¹é…ã€‚ï¼ˆè¿™é‡Œä¼ å…¥äº†routesï¼Œä¸Šé¢çš„ä¼ çš„nullï¼‰
        routes = routeSelection.getAll();
        if (connectionPool.transmitterAcquirePooledConnection(
            address, transmitter, routes, false)) {
          foundPooledConnection = true;
          result = transmitter.connection;
        }
      }
	  //ç¬¬äºŒæ¬¡è¿æ¥æ± ä¹Ÿæ²¡æ‰¾åˆ°ï¼Œå°±æ–°å»ºè¿æ¥
      if (!foundPooledConnection) {
        if (selectedRoute == null) {
          selectedRoute = routeSelection.next();
        }

        // Create a connection and assign it to this allocation immediately. This makes it possible
        // for an asynchronous cancel() to interrupt the handshake we're about to do.
        result = new RealConnection(connectionPool, selectedRoute);
        connectingConnection = result;
      }
    }

    // å¦‚æœç¬¬äºŒæ¬¡ä»è¿æ¥æ± çš„å°è¯•æˆåŠŸäº†ï¼Œç»“æŸï¼Œå› ä¸ºè¿æ¥æ± ä¸­çš„è¿æ¥æ˜¯å·²ç»å’ŒæœåŠ¡å™¨å»ºç«‹è¿æ¥çš„
    if (foundPooledConnection) {
      eventListener.connectionAcquired(call, result);
      return result;
    }

    // ç¬¬äºŒæ¬¡æ²¡æˆåŠŸï¼Œå°±æŠŠæ–°å»ºçš„è¿æ¥ï¼Œè¿›è¡ŒTCP + TLS æ¡æ‰‹ï¼Œä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥. æ˜¯é˜»å¡æ“ä½œ
    result.connect(connectTimeout, readTimeout, writeTimeout, pingIntervalMillis,
        connectionRetryEnabled, call, eventListener);
    connectionPool.routeDatabase.connected(result.route());//ä»å¤±è´¥åå•ä¸­ç§»é™¤

    Socket socket = null;
    synchronized (connectionPool) {
      connectingConnection = null;
      // æœ€åä¸€æ¬¡å°è¯•ä»è¿æ¥æ± è·å–ï¼Œæ³¨æ„æœ€åä¸€ä¸ªå‚æ•°ä¸ºtrueï¼Œå³è¦æ±‚ å¤šè·¯å¤ç”¨ï¼ˆhttp2.0ï¼‰
      //æ„æ€æ˜¯ï¼Œå¦‚æœæœ¬æ¬¡æ˜¯http2.0ï¼Œé‚£ä¹ˆä¸ºäº†ä¿è¯ å¤šè·¯å¤ç”¨æ€§ï¼Œï¼ˆå› ä¸ºä¸Šé¢çš„æ¡æ‰‹æ“ä½œä¸æ˜¯çº¿ç¨‹å®‰å…¨ï¼‰ä¼šå†æ¬¡ç¡®è®¤è¿æ¥æ± ä¸­æ­¤æ—¶æ˜¯å¦å·²æœ‰åŒæ ·è¿æ¥
      if (connectionPool.transmitterAcquirePooledConnection(address, transmitter, routes, true)) {
        // å¦‚æœè·å–åˆ°ï¼Œå°±å…³é—­æˆ‘ä»¬åˆ›å»ºé‡Œçš„è¿æ¥ï¼Œè¿”å›è·å–çš„è¿æ¥
        result.noNewExchanges = true;
        socket = result.socket();
        result = transmitter.connection;

        // é‚£ä¹ˆè¿™ä¸ªåˆšåˆšè¿æ¥æˆåŠŸçš„è·¯ç”± å°±å¯ä»¥ ç”¨ä½œä¸‹æ¬¡ å°è¯•çš„è·¯ç”±
        nextRouteToTry = selectedRoute;
      } else {
        //æœ€åä¸€æ¬¡å°è¯•ä¹Ÿæ²¡æœ‰çš„è¯ï¼Œå°±æŠŠåˆšåˆšæ–°å»ºçš„è¿æ¥å­˜å…¥è¿æ¥æ± 
        connectionPool.put(result);
        transmitter.acquireConnectionNoEvents(result);//æŠŠè¿æ¥èµ‹ç»™transmitter
      }
    }
    closeQuietly(socket);//å¦‚æœåˆšåˆšå»ºç«‹çš„è¿æ¥æ²¡ç”¨åˆ°ï¼Œå°±å…³é—­

    eventListener.connectionAcquired(call, result);
    return result;
  }
```
ä»£ç çœ‹ç€å¾ˆé•¿ï¼Œå·²ç»åŠ äº†æ³¨é‡Šï¼Œæ–¹æ³•ç›®çš„å°±æ˜¯ ä¸º æ‰¿è½½æ–°çš„æ•°æ®æµ å¯»æ‰¾ è¿æ¥ã€‚å¯»æ‰¾é¡ºåºæ˜¯ å·²åˆ†é…çš„è¿æ¥ã€è¿æ¥æ± ã€æ–°å»ºè¿æ¥ã€‚æ¢³ç†å¦‚ä¸‹ï¼š

1. é¦–å…ˆä¼šå°è¯•ä½¿ç”¨ å·²ç»™æ•°æ®æµåˆ†é…çš„è¿æ¥ã€‚ï¼ˆå·²åˆ†é…è¿æ¥çš„æƒ…å†µä¾‹å¦‚é‡å®šå‘æ—¶çš„å†æ¬¡è¯·æ±‚ï¼Œè¯´æ˜ä¸Šæ¬¡å·²ç»æœ‰äº†è¿æ¥ï¼‰
2. è‹¥æ²¡æœ‰ å·²åˆ†é…çš„å¯ç”¨è¿æ¥ï¼Œå°±å°è¯•ä»è¿æ¥æ± ä¸­ åŒ¹é…è·å–ã€‚å› ä¸ºæ­¤æ—¶æ²¡æœ‰è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥åŒ¹é…æ¡ä»¶ï¼šaddressä¸€è‡´â€”â€”hostã€portã€ä»£ç†ç­‰ä¸€è‡´ï¼Œä¸” åŒ¹é…çš„è¿æ¥å¯ä»¥æ¥å—æ–°çš„æ•°æ®æµã€‚
3. è‹¥ä»è¿æ¥æ± æ²¡æœ‰è·å–åˆ°ï¼Œåˆ™å–ä¸‹ä¸€ä¸ªä»£ç†çš„è·¯ç”±ä¿¡æ¯ï¼ˆå¤šä¸ª`Route`ï¼Œå³å¤šä¸ªIPåœ°å€ï¼‰ï¼Œå†æ¬¡å°è¯•ä»è¿æ¥æ± è·å–ï¼Œæ­¤æ—¶å¯èƒ½å› ä¸ºè¿æ¥åˆå¹¶è€ŒåŒ¹é…åˆ°ã€‚
4. è‹¥ç¬¬äºŒæ¬¡ä¹Ÿæ²¡æœ‰è·å–åˆ°ï¼Œå°±åˆ›å»º`RealConnection`å®ä¾‹ï¼Œè¿›è¡Œ`TCP + TLS` æ¡æ‰‹ï¼Œä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥ã€‚
5. æ­¤æ—¶ä¸ºäº†ç¡®ä¿Http2.0è¿æ¥çš„å¤šè·¯å¤ç”¨æ€§ï¼Œä¼šç¬¬ä¸‰æ¬¡ä»è¿æ¥æ± åŒ¹é…ã€‚å› ä¸ºæ–°å»ºç«‹çš„è¿æ¥çš„æ¡æ‰‹è¿‡ç¨‹æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æ­¤æ—¶å¯èƒ½è¿æ¥æ± æ–°å­˜å…¥äº†ç›¸åŒçš„è¿æ¥ã€‚
6. ç¬¬ä¸‰æ¬¡è‹¥åŒ¹é…åˆ°ï¼Œå°±ä½¿ç”¨å·²æœ‰è¿æ¥ï¼Œé‡Šæ”¾åˆšåˆšæ–°å»ºçš„è¿æ¥ï¼›è‹¥æœªåŒ¹é…åˆ°ï¼Œåˆ™æŠŠæ–°è¿æ¥å­˜å…¥è¿æ¥æ± å¹¶è¿”å›ã€‚

æµç¨‹å›¾å¦‚ä¸‹ï¼š
![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/6/14/172b2ffdbdb88963~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)

çœ‹åˆ°è¿™é‡Œï¼Œå°ç›†å‹ï¼Œä½ æ˜¯å¦æœ‰å¾ˆå¤šé—®å·ï¼Ÿ

- å¼€å§‹è‹¥æœ‰äº†å·²åˆ†é…çš„è¿æ¥ï¼Œä½†å·²ç»è¢«é™åˆ¶æ‰¿è½½æ–°çš„æ•°æ®æµï¼Œæ˜¯å¦‚ä½•é‡Šæ”¾çš„å‘¢ï¼Ÿ
- ä»£ç†è·¯ç”±ä¿¡æ¯æ˜¯å¦‚ä½•è·å–çš„å‘¢ï¼Ÿ
- å¦‚ä½•ä»è¿æ¥æ± è·å–è¿æ¥çš„ï¼Ÿä¸‰æ¬¡æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ

æ²¡å…³ç³»ï¼Œæ…¢æ…¢æ¥ï¼Œæˆ‘ä»¬å…ˆçœ‹ç¬¬äºŒä¸ªé—®å·ï¼Œä»£ç†è·¯ç”±ä¿¡æ¯çš„è·å–ã€‚

#### 2.2. RouteSelector
å…ˆæ¥çœ‹ä¸‹Routeç±»ï¼š
```java
public final class Route {
  final Address address;
  final Proxy proxy;//ä»£ç†
  final InetSocketAddress inetSocketAddress;//è¿æ¥ç›®æ ‡åœ°å€

  public Route(Address address, Proxy proxy, InetSocketAddress inetSocketAddress) {
    ...
    this.address = address;
    this.proxy = proxy;
    this.inetSocketAddress = inetSocketAddress;
  }
}
```
**Routeï¼Œé€šè¿‡ä»£ç†æœåŠ¡å™¨ä¿¡æ¯ proxyã€è¿æ¥ç›®æ ‡åœ°å€ InetSocketAddress æ¥æè¿°ä¸€æ¡ è¿æ¥æœåŠ¡å™¨çš„å…·ä½“è·¯ç”±**ã€‚

- `proxy`ä»£ç†ï¼šå¯ä»¥ä¸ºå®¢æˆ·ç«¯æ˜¾å¼é…ç½®ä»£ç†æœåŠ¡å™¨ã€‚å¦åˆ™ï¼Œå°†ä½¿ç”¨`ProxySelector`ä»£ç†é€‰æ‹©å™¨ã€‚å¯èƒ½ä¼šè¿”å›å¤šä¸ªä»£ç†ã€‚
- `IP`åœ°å€ï¼šæ— è®ºæ˜¯ç›´è¿è¿˜æ˜¯ä»£ç†ï¼Œæ‰“å¼€`socket`è¿æ¥éƒ½éœ€è¦`IP`åœ°å€ã€‚` DNS`æœåŠ¡å¯èƒ½è¿”å›å¤šä¸ª`IP`åœ°å€å°è¯•ã€‚

ä¸Šé¢åˆ†æçš„`findConnection`æ–¹æ³•ä¸­æ˜¯ä½¿ç”¨`routeSelection.getAll()`è·å–`Route`é›†åˆ`routes`ï¼Œè€Œ`routeSelection`æ˜¯é€šè¿‡`routeSelector.next()`è·å–ï¼Œ`routeSelector`æ˜¯åœ¨`ExchangeFinder`çš„æ„é€ æ–¹æ³•å†…åˆ›å»ºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´`routeSelector`åœ¨`RetryAndFollowUpInterceptor`ä¸­å°±åˆ›å»ºäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸‹`RouteSelector`ï¼š
```java
  RouteSelector(Address address, RouteDatabase routeDatabase, Call call,
      EventListener eventListener) {
    this.address = address;
    this.routeDatabase = routeDatabase;//è¿æ¥æ± ä¸­çš„è·¯ç”±é»‘åå•ï¼ˆè¿æ¥å¤±è´¥çš„è·¯ç”±ï¼‰
    this.call = call;
    this.eventListener = eventListener;

    resetNextProxy(address.url(), address.proxy());
  }
  //æ”¶é›†ä»£ç†æœåŠ¡å™¨
  private void resetNextProxy(HttpUrl url, Proxy proxy) {
    if (proxy != null) {
      // è‹¥æŒ‡å®šäº†ä»£ç†ï¼Œé‚£ä¹ˆå°±è¿™ä¸€ä¸ªã€‚ï¼ˆå°±æ˜¯åˆå§‹åŒ–OkhttpClientæ—¶é…ç½®çš„ï¼‰
      proxies = Collections.singletonList(proxy);
    } else {
      //æ²¡é…ç½®å°±ä½¿ç”¨ProxySelectorè·å–ä»£ç†ï¼ˆè‹¥åˆå§‹åŒ–OkhttpClientæ—¶æ²¡æœ‰é…ç½®ProxySelectorï¼Œä¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„ï¼‰ 
      List<Proxy> proxiesOrNull = address.proxySelector().select(url.uri());
      proxies = proxiesOrNull != null && !proxiesOrNull.isEmpty()
          ? Util.immutableList(proxiesOrNull)
          : Util.immutableList(Proxy.NO_PROXY);
    }
    nextProxyIndex = 0;
  }
```
æ³¨æ„åˆ°`RouteSelector`çš„æ„é€ æ–¹æ³•ä¸­ä¼ å…¥äº†`routeDatabase`ï¼Œæ˜¯è¿æ¥å¤±è´¥çš„è·¯ç”±é»‘åå•ï¼ˆåé¢è¿æ¥æ± ä¹Ÿä¼šè®²åˆ°ï¼‰ï¼Œå¹¶ä½¿ç”¨`resetNextProxy`æ–¹æ³•è·å–ä»£ç†æœåŠ¡å™¨åˆ—è¡¨ï¼šè‹¥æ²¡æœ‰æŒ‡å®š`proxy`å°±æ˜¯ç”¨`ProxySelector`è·å–`proxy`åˆ—è¡¨ï¼ˆè‹¥æ²¡æœ‰é…ç½®`ProxySelector`ä¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤ï¼‰ã€‚æ¥ç€çœ‹`next`æ–¹æ³•ï¼š
```java
  //æ”¶é›†ä»£ç†çš„è·¯ç”±ä¿¡æ¯
  public Selection next() throws IOException {
    if (!hasNext()) {//è¿˜æœ‰ä¸‹ä¸€ä¸ªä»£ç†
      throw new NoSuchElementException();
    }

    List<Route> routes = new ArrayList<>();
    while (hasNextProxy()) {
      Proxy proxy = nextProxy();
      //éå†proxyç»DNSåçš„æ‰€æœ‰IPåœ°å€ï¼Œç»„è£…æˆRoute
      for (int i = 0, size = inetSocketAddresses.size(); i < size; i++) {
        Route route = new Route(address, proxy, inetSocketAddresses.get(i));
        if (routeDatabase.shouldPostpone(route)) {//æ­¤è·¯ç”±åœ¨é»‘åå•ä¸­ï¼Œå­˜èµ·æ¥æœ€åå°è¯•
          postponedRoutes.add(route);
        } else {
          routes.add(route);
        }
      }

      if (!routes.isEmpty()) {
        break;
      }
    }

    if (routes.isEmpty()) {
      // è‹¥æ²¡æœ‰æ‹¿åˆ°è·¯ç”±ï¼Œå°±å°è¯•ä¸Šé¢å­˜çš„é»‘åå•çš„è·¯ç”±
      routes.addAll(postponedRoutes);
      postponedRoutes.clear();
    }
    //routesåŒ…è£…æˆSelectionè¿”å›
    return new Selection(routes);
  }
```
`next`æ–¹æ³•ä¸»è¦å°±æ˜¯è·å–ä¸‹ä¸€ä¸ªä»£ç†`Proxy`çš„ä»£ç†ä¿¡æ¯ï¼Œå³å¤šä¸ªè·¯ç”±ã€‚å…·ä½“æ˜¯åœ¨`resetNextInetSocketAddress`æ–¹æ³•ä¸­å®ç°ï¼Œä¸»è¦æ˜¯å¯¹ä»£ç†æœåŠ¡åœ°å€è¿›è¡Œ`DNS`è§£æè·å–å¤šä¸ª`IP`åœ°å€ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ`OkHttp`ä¸­çš„ä»£ç†å’Œè·¯ç”±ã€‚
å¥½äº†ï¼Œåˆ°è¿™é‡Œ å°±è§£å†³äº†ç¬¬äºŒä¸ªé—®å·ã€‚å…¶ä»–ä¸¤ä¸ªé—®å·æ¶‰åŠ è¿æ¥æ± `RealConnectionPool`ã€è¿æ¥`RealConnection`ï¼Œä¸‹é¢å°±æ¥ç…ç…ã€‚

#### 2.3. ConnectionPool
`ConnectionPool`ï¼Œå³è¿æ¥æ± ï¼Œç”¨äºç®¡ç†`http1.1/http2.0`è¿æ¥é‡ç”¨ï¼Œä»¥å‡å°‘ç½‘ç»œå»¶è¿Ÿã€‚ç›¸åŒ`Address`çš„`http`è¯·æ±‚å¯ä»¥å…±äº«ä¸€ä¸ªè¿æ¥ï¼Œ`ConnectionPool`å°±æ˜¯å®ç°äº†è¿æ¥çš„å¤ç”¨ã€‚
```java
public final class ConnectionPool {
  final RealConnectionPool delegate;
  //æœ€å¤§ç©ºé—²è¿æ¥æ•°5ï¼Œæœ€å¤§ç©ºé—²æ—¶é—´5åˆ†é’Ÿ
  public ConnectionPool() {
    this(5, 5, TimeUnit.MINUTES);
  }
  
  public ConnectionPool(int maxIdleConnections, long keepAliveDuration, TimeUnit timeUnit) {
    this.delegate = new RealConnectionPool(maxIdleConnections, keepAliveDuration, timeUnit);
  }
  //è¿”å›ç©ºé—²è¿æ¥æ•°
  public int idleConnectionCount() {
    return delegate.idleConnectionCount();
  }
  //è¿”å›æ± å­ä¸­çš„è¿æ¥æ•°
  public int connectionCount() {
    return delegate.connectionCount();
  }
  //å…³é—­å¹¶ç§»é™¤æ‰€ä»¥ç©ºé—²è¿æ¥
  public void evictAll() {
    delegate.evictAll();
  }
}
```
`ConnectionPool`çœ‹èµ·æ¥æ¯”è¾ƒå¥½ç†è§£ï¼Œé»˜è®¤é…ç½®æ˜¯æœ€å¤§ç©ºé—²è¿æ¥æ•°`5`ï¼Œæœ€å¤§ç©ºé—²æ—¶é—´`5`åˆ†é’Ÿï¼ˆå³ä¸€ä¸ªè¿æ¥ç©ºé—²æ—¶é—´è¶…è¿‡`5`åˆ†é’Ÿå°±ç§»é™¤ï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨åˆå§‹åŒ–`okhttpClient`æ—¶è¿›è¡Œä¸åŒçš„é…ç½®ã€‚éœ€è¦æ³¨æ„çš„æ˜¯`ConnectionPool`æ˜¯ç”¨äºåº”ç”¨å±‚ï¼Œå®é™…ç®¡ç†è€…æ˜¯`RealConnectionPool`ã€‚`RealConnectionPool`æ˜¯`okhttp`å†…éƒ¨çœŸå®ç®¡ç†è¿æ¥çš„åœ°æ–¹ã€‚
è¿æ¥æ± å¯¹è¿æ¥çš„ç®¡ç†æ— éæ˜¯ **å­˜**ã€**å–**ã€**åˆ **ï¼Œä¸Šé¢çš„ä¸¤ä¸ªé—®å·åˆ†åˆ«å¯¹åº” åˆ ã€å–ï¼Œè·Ÿè¿›RealConnectionPoolæˆ‘ä»¬ä¸€ä¸ªä¸ªçœ‹ï¼š

##### 2.3.1 å­˜
```java
  private final Deque<RealConnection> connections = new ArrayDeque<>();
  
  private final Runnable cleanupRunnable = () -> {
    //å¾ªç¯æ¸…ç†
    while (true) {
      //æ¸…ç†
      long waitNanos = cleanup(System.nanoTime());
      if (waitNanos == -1) return;
      if (waitNanos > 0) {
        long waitMillis = waitNanos / 1000000L;
        waitNanos -= (waitMillis * 1000000L);
        synchronized (RealConnectionPool.this) {
          try {
            //ä¸‹ä¸€æ¬¡æ¸…ç†ä¹‹å‰çš„ç­‰å¾…
            RealConnectionPool.this.wait(waitMillis, (int) waitNanos);
          } catch (InterruptedException ignored) {
          }
        }
      }
    }
  };
  //å­˜
  void put(RealConnection connection) {
    assert (Thread.holdsLock(this));
    if (!cleanupRunning) {
      cleanupRunning = true;
      executor.execute(cleanupRunnable);
    }
    connections.add(connection);
  }
```
`connections`æ˜¯ç”¨äºå­˜è¿æ¥çš„é˜Ÿåˆ—`Deque`ã€‚çœ‹åˆ°åœ¨`add`ä¹‹å‰ ä½¿ç”¨çº¿ç¨‹æ± `executor`æ‰§è¡Œäº†`cleanupRunnable`ï¼Œæ„æ€æ˜¯æ¸…ç†è¿æ¥ï¼Œä¸ºå•¥è¦æ¸…ç†å‘¢ï¼Ÿä¸Šé¢æåˆ°è¿‡ è¿æ¥æ± æœ‰ æœ€å¤§ç©ºé—²è¿æ¥æ•°ã€æœ€å¤§ç©ºé—²æ—¶é—´çš„é™åˆ¶ï¼Œæ‰€ä»¥ä¸æ»¡è¶³æ—¶æ˜¯è¦è¿›è¡Œæ¸…ç†çš„ã€‚å¹¶ä¸”æ³¨æ„åˆ°æ¸…ç†æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå¹¶ä¸”ä¸‹ä¸€æ¬¡æ¸…ç†å‰è¦ç­‰å¾…`waitNanos`æ—¶é—´ï¼Œå•¥æ„æ€å‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸‹`cleanup`æ–¹æ³•ï¼š
```java
  long cleanup(long now) {
    int inUseConnectionCount = 0;//æ­£åœ¨ä½¿ç”¨çš„è¿æ¥æ•°
    int idleConnectionCount = 0;//ç©ºé—²è¿æ¥æ•°
    RealConnection longestIdleConnection = null;//ç©ºé—²æ—¶é—´æœ€é•¿çš„è¿æ¥
    long longestIdleDurationNs = Long.MIN_VALUE;//æœ€é•¿çš„ç©ºé—²æ—¶é—´

    //éå†è¿æ¥ï¼šæ‰¾åˆ°å¾…æ¸…ç†çš„è¿æ¥, æ‰¾åˆ°ä¸‹ä¸€æ¬¡è¦æ¸…ç†çš„æ—¶é—´ï¼ˆè¿˜æœªåˆ°æœ€å¤§ç©ºé—²æ—¶é—´ï¼‰
    synchronized (this) {
      for (Iterator<RealConnection> i = connections.iterator(); i.hasNext(); ) {
        RealConnection connection = i.next();

        //è‹¥è¿æ¥æ­£åœ¨ä½¿ç”¨ï¼Œcontinueï¼Œæ­£åœ¨ä½¿ç”¨è¿æ¥æ•°+1
        if (pruneAndGetAllocationCount(connection, now) > 0) {
          inUseConnectionCount++;
          continue;
        }
		//ç©ºé—²è¿æ¥æ•°+1
        idleConnectionCount++;

        // èµ‹å€¼æœ€é•¿çš„ç©ºé—²æ—¶é—´å’Œå¯¹åº”è¿æ¥
        long idleDurationNs = now - connection.idleAtNanos;
        if (idleDurationNs > longestIdleDurationNs) {
          longestIdleDurationNs = idleDurationNs;
          longestIdleConnection = connection;
        }
      }
	  //è‹¥æœ€é•¿çš„ç©ºé—²æ—¶é—´å¤§äº5åˆ†é’Ÿ æˆ– ç©ºé—²æ•° å¤§äº5ï¼Œå°±ç§»é™¤å¹¶å…³é—­è¿™ä¸ªè¿æ¥
      if (longestIdleDurationNs >= this.keepAliveDurationNs
          || idleConnectionCount > this.maxIdleConnections) {
        connections.remove(longestIdleConnection);
      } else if (idleConnectionCount > 0) {
        // elseï¼Œå°±è¿”å› è¿˜å‰©å¤šä¹…åˆ°è¾¾5åˆ†é’Ÿï¼Œç„¶åwaitè¿™ä¸ªæ—¶é—´å†æ¥æ¸…ç†
        return keepAliveDurationNs - longestIdleDurationNs;
      } else if (inUseConnectionCount > 0) {
        //è¿æ¥æ²¡æœ‰ç©ºé—²çš„ï¼Œå°±5åˆ†é’Ÿåå†å°è¯•æ¸…ç†.
        return keepAliveDurationNs;
      } else {
        // æ²¡æœ‰è¿æ¥ï¼Œä¸æ¸…ç†
        cleanupRunning = false;
        return -1;
      }
    }
	//å…³é—­ç§»é™¤çš„è¿æ¥
    closeQuietly(longestIdleConnection.socket());

    //å…³é—­ç§»é™¤å ç«‹åˆ» è¿›è¡Œä¸‹ä¸€æ¬¡çš„ å°è¯•æ¸…ç†
    return 0;
  }
```

æ€è·¯è¿˜æ˜¯å¾ˆæ¸…æ™°çš„ï¼š

1. æœ‰ç©ºé—²è¿æ¥çš„è¯ï¼Œå¦‚æœæœ€é•¿çš„ç©ºé—²æ—¶é—´å¤§äº5åˆ†é’Ÿ æˆ– ç©ºé—²æ•° å¤§äº5ï¼Œå°±ç§»é™¤å…³é—­è¿™ä¸ªæœ€é•¿ç©ºé—²è¿æ¥ï¼›å¦‚æœ ç©ºé—²æ•° ä¸å¤§äº5 ä¸” æœ€é•¿çš„ç©ºé—²æ—¶é—´ä¸å¤§äº5åˆ†é’Ÿï¼Œå°±è¿”å›åˆ°5åˆ†é’Ÿçš„å‰©ä½™æ—¶é—´ï¼Œç„¶åç­‰å¾…è¿™ä¸ªæ—¶é—´å†æ¥æ¸…ç†ã€‚
2. æ²¡æœ‰ç©ºé—²è¿æ¥å°±ç­‰5åˆ†é’Ÿåå†å°è¯•æ¸…ç†ã€‚
3. æ²¡æœ‰è¿æ¥ä¸æ¸…ç†ã€‚

å…¶ä¸­åˆ¤æ–­è¿æ¥æ­£åœ¨ä½¿ç”¨çš„æ–¹æ³•`pruneAndGetAllocationCount`æˆ‘ä»¬æ¥çœ‹ä¸‹ï¼š
```java
  private int pruneAndGetAllocationCount(RealConnection connection, long now) {
    //è¿æ¥ä¸Šçš„æ•°æ®æµï¼Œå¼±å¼•ç”¨åˆ—è¡¨
    List<Reference<Transmitter>> references = connection.transmitters;
    for (int i = 0; i < references.size(); ) {
      Reference<Transmitter> reference = references.get(i);
      if (reference.get() != null) {
        i++;
        continue;
      }

      // åˆ°è¿™é‡Œï¼Œtransmitteræ˜¯æ³„æ¼çš„ï¼Œè¦ç§»é™¤ï¼Œä¸”æ­¤è¿æ¥ä¸èƒ½å†æ‰¿è½½æ–°çš„æ•°æ®æµï¼ˆæ³„æ¼çš„åŸå› å°±æ˜¯ä¸‹é¢çš„messageï¼‰
      TransmitterReference transmitterRef = (TransmitterReference) reference;
      String message = "A connection to " + connection.route().address().url()
          + " was leaked. Did you forget to close a response body?";
      Platform.get().logCloseableLeak(message, transmitterRef.callStackTrace);
      references.remove(i);
      connection.noNewExchanges = true;

      //è¿æ¥å› ä¸ºæ³„æ¼æ²¡æœ‰æ•°æ®æµäº†ï¼Œé‚£ä¹ˆå¯ä»¥ç«‹å³ç§»é™¤äº†ã€‚æ‰€ä»¥è®¾ç½® å¼€å§‹ç©ºé—²æ—¶é—´ æ˜¯5åˆ†é’Ÿå‰ï¼ˆå‰å®³å‰å®³ï¼ï¼‰
      if (references.isEmpty()) {
        connection.idleAtNanos = now - keepAliveDurationNs;
        return 0;
      }
    }
    //è¿”å›è¿æ¥ä¸Šçš„æ•°æ®æµæ•°é‡ï¼Œå¤§äº0è¯´æ˜æ­£åœ¨ä½¿ç”¨ã€‚
    return references.size();
  }
```
é€»è¾‘æ³¨é‡Šå·²ç»æ ‡æ˜äº†ï¼Œå¾ˆå¥½ç†è§£ã€‚å…¶ä¸­`connection.transmitters`ï¼Œè¡¨ç¤ºåœ¨æ­¤è¿æ¥ä¸Šçš„æ•°æ®æµï¼Œ`transmitters` `size`å¤§äº`1`å³è¡¨ç¤ºå¤šä¸ªè¯·æ±‚å¤ç”¨æ­¤è¿æ¥ã€‚
å¦å¤–ï¼Œåœ¨`findConnection`ä¸­ï¼Œä½¿ç”¨`connectionPool.put(result)`å­˜è¿æ¥åï¼Œåˆè°ƒç”¨`transmitter.acquireConnectionNoEvents`æ–¹æ³•ï¼Œç…ä¸‹ï¼š
```java
  void acquireConnectionNoEvents(RealConnection connection) {
    assert (Thread.holdsLock(connectionPool));
    if (this.connection != null) throw new IllegalStateException();
    this.connection = connection;
    connection.transmitters.add(new TransmitterReference(this, callStackTrace));
  }
```
å…ˆæŠŠè¿æ¥èµ‹ç»™`transmitter`ï¼Œè¡¨ç¤ºæ•°æ®æµ`transmitter`ä¾é™„åœ¨è¿™ä¸ª`connection`ä¸Šï¼›ç„¶å`connection.transmitters` `add` è¿™ä¸ª`transmitter`çš„å¼±å¼•ç”¨ï¼Œ`connection.transmitters`è¡¨ç¤ºè¿™ä¸ªè¿æ¥æ‰¿è½½çš„æ‰€æœ‰æ•°æ®æµï¼Œå³æ‰¿è½½çš„æ‰€æœ‰è¯·æ±‚ã€‚
å¥½äº†ï¼Œå­˜ è®²å®Œäº†ï¼Œä¸»è¦å°±æ˜¯æŠŠè¿æ¥å­˜å…¥é˜Ÿåˆ—ï¼ŒåŒæ—¶å¼€å§‹å¾ªç¯å°è¯•æ¸…ç†è¿‡æœŸè¿æ¥ã€‚

##### 2.3.2. å–
```java
  //ä¸ºtransmitter ä»è¿æ¥æ±  è·å– å¯¹åº”addressçš„è¿æ¥ã€‚è‹¥æœroutesä¸ä¸ºç©ºï¼Œå¯èƒ½ä¼šå› ä¸º è¿æ¥åˆå¹¶ï¼ˆå¤ç”¨ï¼‰ è€Œè·å–åˆ°HTTP/2è¿æ¥ã€‚
  boolean transmitterAcquirePooledConnection(Address address, Transmitter transmitter,
      @Nullable List<Route> routes, boolean requireMultiplexed) {
    assert (Thread.holdsLock(this));
    for (RealConnection connection : connections) {
      if (requireMultiplexed && !connection.isMultiplexed()) continue;
      if (!connection.isEligible(address, routes)) continue;
      transmitter.acquireConnectionNoEvents(connection);
      return true;
    }
    return false;
  }
```
å­˜çš„æ–¹æ³•åæ˜¯`put`ï¼Œä½†ä½ å‘ç° å– çš„æ–¹æ³•åå´ä¸æ˜¯`get`ï¼Œ`transmitterAcquirePooledConnection`æ„æ€æ˜¯ ä¸º`transmitter` ä»è¿æ¥æ±  è·å–è¿æ¥ï¼Œå®é™…ä¸Š`transmitter`å°±ä»£è¡¨ä¸€ä¸ªæ•°æ®æµï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª`http`è¯·æ±‚ã€‚æ³¨æ„åˆ°ï¼Œåœ¨éå†ä¸­ ç»è¿‡åˆ¤æ–­åä¹Ÿæ˜¯`transmitter`çš„`acquireConnectionNoEvents`æ–¹æ³•ï¼Œå³æŠŠåŒ¹é…åˆ°çš„`connection`èµ‹ç»™`transmitter`ã€‚æ‰€ä»¥æ–¹æ³•åè¿˜æ˜¯å¾ˆç”ŸåŠ¨çš„ã€‚
ç»§ç»­çœ‹æ˜¯å¦‚ä½•åŒ¹é…çš„ï¼šå¦‚æœ`requireMultiplexed`ä¸º`false`ï¼Œå³ä¸æ˜¯å¤šè·¯å¤ç”¨ï¼ˆä¸æ˜¯`http/2`ï¼‰ï¼Œé‚£ä¹ˆå°±è¦çœ‹`Connection`çš„`isEligible`æ–¹æ³•äº†ï¼Œ`isEligible`æ–¹æ³•è¿”å›`true`ï¼Œå°±ä»£è¡¨åŒ¹é…æˆåŠŸï¼š
```java
  //ç”¨äºåˆ¤æ–­ è¿æ¥ æ˜¯å¦ å¯ä»¥æ‰¿è½½æŒ‡å‘addressçš„æ•°æ®æµ
  boolean isEligible(Address address, @Nullable List<Route> routes) {
    //è¿æ¥ä¸å†æ¥å—æ–°çš„æ•°æ®æµï¼Œfalse
    if (transmitters.size() >= allocationLimit || noNewExchanges) return false;

    //åŒ¹é…addressä¸­éhostçš„éƒ¨åˆ†
    if (!Internal.instance.equalsNonHost(this.route.address(), address)) return false;

    //åŒ¹é…addressçš„hostï¼Œåˆ°è¿™é‡Œä¹ŸåŒ¹é…çš„è¯ï¼Œå°±return true
    if (address.url().host().equals(this.route().address().url().host())) {
      return true; // This connection is a perfect match.
    }

    //åˆ°è¿™é‡Œhostnameæ˜¯æ²¡åŒ¹é…çš„ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰æœºä¼šè¿”å›trueï¼šè¿æ¥åˆå¹¶
    // 1. è¿æ¥é¡»æ˜¯ HTTP/2.
    if (http2Connection == null) return false;

    // 2. IP åœ°å€åŒ¹é…
    if (routes == null || !routeMatchesAny(routes)) return false;

    // 3. è¯ä¹¦åŒ¹é…
    if (address.hostnameVerifier() != OkHostnameVerifier.INSTANCE) return false;
    if (!supportsUrl(address.url())) return false;

    // 4. è¯ä¹¦ pinning åŒ¹é….
    try {
      address.certificatePinner().check(address.url().host(), handshake().peerCertificates());
    } catch (SSLPeerUnverifiedException e) {
      return false;
    }

    return true; // The caller's address can be carried by this connection.
  }

  private boolean routeMatchesAny(List<Route> candidates) {
    for (int i = 0, size = candidates.size(); i < size; i++) {
      Route candidate = candidates.get(i);
      if (candidate.proxy().type() == Proxy.Type.DIRECT
          && route.proxy().type() == Proxy.Type.DIRECT
          && route.socketAddress().equals(candidate.socketAddress())) {
        return true;
      }
    }
    return false;
  }
```
å–çš„è¿‡ç¨‹å°±æ˜¯ éå†è¿æ¥æ± ï¼Œè¿›è¡Œåœ°å€ç­‰ä¸€ç³»åˆ—åŒ¹é…ï¼Œåˆ°è¿™é‡Œç¬¬ä¸‰ä¸ªé—®å·ä¹Ÿè§£å†³äº†ã€‚

##### 2.3.3. åˆ 
```java
  //ç§»é™¤å…³é—­ç©ºé—²è¿æ¥
  public void evictAll() {
    List<RealConnection> evictedConnections = new ArrayList<>();
    synchronized (this) {
      for (Iterator<RealConnection> i = connections.iterator(); i.hasNext(); ) {
        RealConnection connection = i.next();
        if (connection.transmitters.isEmpty()) {
          connection.noNewExchanges = true;
          evictedConnections.add(connection);
          i.remove();
        }
      }
    }

    for (RealConnection connection : evictedConnections) {
      closeQuietly(connection.socket());
    }
  }
```
éå†è¿æ¥æ± ï¼Œå¦‚æœè¿æ¥ä¸Šçš„æ•°æ®æµæ˜¯ç©ºï¼Œé‚£ä¹ˆå°±ä»è¿æ¥æ± ç§»é™¤å¹¶ä¸”å…³é—­ã€‚
æˆ‘ä»¬å›è¿‡å¤´çœ‹ä¸‹`Transmitter`çš„`releaseConnectionNoEvents`æ–¹æ³•ï¼Œä¹Ÿå°±ç¬¬ä¸€ä¸ªé—®å·ï¼Œå¦‚æœè¿æ¥ä¸å†æ¥å—æ–°çš„æ•°æ®æµï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼š
```java
  //ä»è¿æ¥ä¸Šç§»é™¤transmitter.
  @Nullable Socket releaseConnectionNoEvents() {
    assert (Thread.holdsLock(connectionPool));

    int index = -1;
    //éå† æ­¤æ•°æ®æµä¾é™„çš„è¿æ¥ ä¸Šçš„æ‰€æœ‰æ•°æ®æµï¼Œæ‰¾åˆ°index
    for (int i = 0, size = this.connection.transmitters.size(); i < size; i++) {
      Reference<Transmitter> reference = this.connection.transmitters.get(i);
      if (reference.get() == this) {
        index = i;
        break;
      }
    }

    if (index == -1) throw new IllegalStateException();
	//transmittersç§»é™¤æ­¤æ•°æ®æµ
    RealConnection released = this.connection;
    released.transmitters.remove(index);
    this.connection = null;
	//å¦‚æœè¿æ¥ä¸Šæ²¡æœ‰æœ‰æ•°æ®æµäº†ï¼Œå°±ç½®ä¸ºç©ºé—²ï¼ˆç­‰å¾…æ¸…ç†ï¼‰ï¼Œå¹¶è¿”å›å¾…å…³é—­çš„socket
    if (released.transmitters.isEmpty()) {
      released.idleAtNanos = System.nanoTime();
      if (connectionPool.connectionBecameIdle(released)) {
        return released.socket();
      }
    }

    return null;
  }
```
ä¸»è¦å°±æ˜¯å°è¯•é‡Šæ”¾è¿æ¥ï¼Œè¿æ¥ä¸Šæ²¡æœ‰æ•°æ®æµå°±å…³é—­`socket`ç­‰å¾…è¢«æ¸…ç†ã€‚
å¥½äº†ï¼Œåˆ°è¿™é‡Œè¿æ¥æ± çš„ç®¡ç†å°±åˆ†æå®Œäº†ã€‚
ä»è¿æ¥çš„æŸ¥æ‰¾ åˆ° è¿æ¥æ± çš„ç®¡ç†ï¼Œå°±æ˜¯`ConnectInterceptor`çš„å†…å®¹äº†ã€‚

### 3. `CallServerInterceptor`
å“å‘€ï¼Œç»ˆäºåˆ°æœ€åä¸€ä¸ªæ‹¦æˆªå™¨äº†ï¼
è¯·æ±‚æœåŠ¡æ‹¦æˆªå™¨ï¼Œä¹Ÿå°±æ˜¯çœŸæ­£åœ°å»è¿›è¡Œç½‘ç»œ`IO`è¯»å†™äº†â€”â€”å†™å…¥`http`è¯·æ±‚çš„`header`å’Œ`body`æ•°æ®ã€è¯»å–å“åº”çš„`header`å’Œ`body`ã€‚
ä¸Šé¢`ConnectInterceptor`ä¸»è¦ä»‹ç»äº†å¦‚ä½• **å¯»æ‰¾è¿æ¥** ä»¥åŠ **è¿æ¥æ± å¦‚ä½•ç®¡ç†è¿æ¥**ã€‚åœ¨è·å–åˆ°è¿æ¥åï¼Œè°ƒç”¨äº†`RealConnection`çš„`newCodec`æ–¹æ³•`ExchangeCodec`å®ä¾‹ï¼Œç„¶åä½¿ç”¨`ExchangeCodec`å®ä¾‹åˆ›å»ºäº†`Exchange`å®ä¾‹ä¼ å…¥`CallServerInterceptor`äº†ã€‚ä¸Šé¢æåˆ°è¿‡`ExchangeCodec`è´Ÿè´£è¯·æ±‚å’Œå“åº”çš„`IO`è¯»å†™ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹`ExchangeCodec`åˆ›å»ºè¿‡ç¨‹â€”â€”`RealConnection`çš„`newCodec`æ–¹æ³•ï¼š
```java
  ExchangeCodec newCodec(OkHttpClient client, Interceptor.Chain chain) throws SocketException {
    if (http2Connection != null) {
      return new Http2ExchangeCodec(client, this, chain, http2Connection);
    } else {
      socket.setSoTimeout(chain.readTimeoutMillis());
      source.timeout().timeout(chain.readTimeoutMillis(), MILLISECONDS);
      sink.timeout().timeout(chain.writeTimeoutMillis(), MILLISECONDS);
      return new Http1ExchangeCodec(client, this, source, sink);
    }
  }
```
`http2Connection`ä¸ä¸ºç©ºå°±åˆ›å»º`Http2ExchangeCodec`ï¼Œå¦åˆ™æ˜¯`Http1ExchangeCodec`ã€‚è€Œ`http2Connection`çš„åˆ›å»ºæ˜¯è¿æ¥è¿›è¡Œ`TCP`ã€`TLS`æ¡æ‰‹çš„æ—¶å€™ï¼Œå³åœ¨`RealConnection`çš„`connect`æ–¹æ³•ä¸­ï¼Œå…·ä½“å°±æ˜¯`connect`æ–¹æ³•ä¸­è°ƒç”¨çš„`establishProtocol`æ–¹æ³•ï¼š
```java
  private void establishProtocol(ConnectionSpecSelector connectionSpecSelector,
      int pingIntervalMillis, Call call, EventListener eventListener) throws IOException {
    //é’ˆå¯¹httpè¯·æ±‚ï¼Œå¦‚æœé…ç½®çš„åè®®åŒ…å«Protocol.H2_PRIOR_KNOWLEDGEï¼Œåˆ™å¼€å¯Http2è¿æ¥
    if (route.address().sslSocketFactory() == null) {
      if (route.address().protocols().contains(Protocol.H2_PRIOR_KNOWLEDGE)) {
        socket = rawSocket;
        protocol = Protocol.H2_PRIOR_KNOWLEDGE;
        startHttp2(pingIntervalMillis);
        return;
      }

      socket = rawSocket;
      protocol = Protocol.HTTP_1_1;
      return;
    }
	//é’ˆå¯¹httpsè¯·æ±‚ï¼Œä¼šåœ¨TLSæ¡æ‰‹åï¼Œæ ¹æ®å¹³å°è·å–åè®®ï¼ˆï¼‰ï¼Œå¦‚æœåè®®æ˜¯Protocol.HTTP_2ï¼Œåˆ™å¼€å¯Http2è¿æ¥
    eventListener.secureConnectStart(call);
    connectTls(connectionSpecSelector);
    eventListener.secureConnectEnd(call, handshake);

    if (protocol == Protocol.HTTP_2) {
      startHttp2(pingIntervalMillis);
    }
  }

  private void startHttp2(int pingIntervalMillis) throws IOException {
    socket.setSoTimeout(0); // HTTP/2 connection timeouts are set per-stream.
    http2Connection = new Http2Connection.Builder(true)
        .socket(socket, route.address().url().host(), source, sink)
        .listener(this)
        .pingIntervalMillis(pingIntervalMillis)
        .build();
    http2Connection.start();
  }
```
å¥½äº†ï¼Œåˆ°è¿™é‡Œä¸å†æ·±å…¥äº†ï¼Œç»§ç»­äº†è§£å¯ä»¥å‚è€ƒ`HTTP 2.0`ä¸`OkHttp`ã€‚é‚£ä¹ˆåˆ°è¿™é‡Œï¼Œ`ExchangeCodec`å·²ç»åˆ›å»ºäº†ï¼Œç„¶ååˆåŒ…è£…æˆ`Exchange`ï¼Œæœ€åä¼ å…¥äº†`CallServerInterceptor`ã€‚

ä¸‹é¢å°±æ¥çœ‹çœ‹è¿™æœ€åä¸€ä¸ªæ‹¦æˆªå™¨ï¼š
```java
public final class CallServerInterceptor implements Interceptor {
  private final boolean forWebSocket;

  public CallServerInterceptor(boolean forWebSocket) {
    this.forWebSocket = forWebSocket;
  }

  @Override public Response intercept(Chain chain) throws IOException {
    RealInterceptorChain realChain = (RealInterceptorChain) chain;
    Exchange exchange = realChain.exchange();//ä¸Šä¸ªæ‹¦æˆªå™¨ä¼ å…¥çš„exchange
    Request request = realChain.request();

    long sentRequestMillis = System.currentTimeMillis();
	//å†™è¯·æ±‚å¤´
    exchange.writeRequestHeaders(request);

    boolean responseHeadersStarted = false;
    Response.Builder responseBuilder = null;
    //å«bodyçš„è¯·æ±‚
    if (HttpMethod.permitsRequestBody(request.method()) && request.body() != null) {
      // è‹¥è¯·æ±‚å¤´åŒ…å« "Expect: 100-continue" , å°±ä¼šç­‰æœåŠ¡ç«¯è¿”å›å«æœ‰ "HTTP/1.1 100 Continue"çš„å“åº”ï¼Œç„¶åå†å‘é€è¯·æ±‚body. 
      //å¦‚æœæ²¡æœ‰æ”¶åˆ°è¿™ä¸ªå“åº”ï¼ˆä¾‹å¦‚æ”¶åˆ°çš„å“åº”æ˜¯4xxï¼‰ï¼Œé‚£å°±ä¸å‘é€bodyäº†ã€‚
      if ("100-continue".equalsIgnoreCase(request.header("Expect"))) {
        exchange.flushRequest();
        responseHeadersStarted = true;
        exchange.responseHeadersStart();
        responseBuilder = exchange.readResponseHeaders(true);
      }
	  //responseBuilderä¸ºnullè¯´æ˜æœåŠ¡ç«¯è¿”å›äº†100ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ç»§ç»­å‘é€bodyäº†
      if (responseBuilder == null) {
        if (request.body().isDuplex()) {//é»˜è®¤æ˜¯falseä¸ä¼šè¿›å…¥
          // Prepare a duplex body so that the application can send a request body later.
          exchange.flushRequest();
          BufferedSink bufferedRequestBody = Okio.buffer(
              exchange.createRequestBody(request, true));
          request.body().writeTo(bufferedRequestBody);
        } else {
          // æ»¡è¶³äº† "Expect: 100-continue" ï¼Œå†™è¯·æ±‚body
          BufferedSink bufferedRequestBody = Okio.buffer(
              exchange.createRequestBody(request, false));
          request.body().writeTo(bufferedRequestBody);
          bufferedRequestBody.close();
        }
      } else {
       //æ²¡æœ‰æ»¡è¶³ "Expect: 100-continue" ï¼Œè¯·æ±‚å‘é€ç»“æŸ
        exchange.noRequestBody();
        if (!exchange.connection().isMultiplexed()) {
          // If the "Expect: 100-continue" expectation wasn't met, prevent the HTTP/1 connection
          // from being reused. Otherwise we're still obligated to transmit the request body to
          // leave the connection in a consistent state.
          exchange.noNewExchangesOnConnection();
        }
      }
    } else {
     //æ²¡æœ‰bodyï¼Œè¯·æ±‚å‘é€ç»“æŸ
      exchange.noRequestBody();
    }

	//è¯·æ±‚å‘é€ç»“æŸ
    if (request.body() == null || !request.body().isDuplex()) {
      exchange.finishRequest();
    }
	//å›è°ƒ è¯»å“åº”å¤´å¼€å§‹äº‹ä»¶ï¼ˆå¦‚æœä¸Šé¢æ²¡æœ‰ï¼‰
    if (!responseHeadersStarted) {
      exchange.responseHeadersStart();
    }
	//è¯»å“åº”å¤´ï¼ˆå¦‚æœä¸Šé¢æ²¡æœ‰ï¼‰
    if (responseBuilder == null) {
      responseBuilder = exchange.readResponseHeaders(false);
    }
	//æ„å»ºresponse
    Response response = responseBuilder
        .request(request)
        .handshake(exchange.connection().handshake())
        .sentRequestAtMillis(sentRequestMillis)
        .receivedResponseAtMillis(System.currentTimeMillis())
        .build();

    int code = response.code();
    if (code == 100) {
      //è¿™é‡ŒæœåŠ¡ç«¯åˆè¿”å›äº†ä¸ª100ï¼Œå°±å†å°è¯•è·å–çœŸæ­£çš„å“åº”ï¼ˆï¼‰
      response = exchange.readResponseHeaders(false)
          .request(request)
          .handshake(exchange.connection().handshake())
          .sentRequestAtMillis(sentRequestMillis)
          .receivedResponseAtMillis(System.currentTimeMillis())
          .build();

      code = response.code();
    }
	//å›è°ƒè¯»å“åº”å¤´ç»“æŸ
    exchange.responseHeadersEnd(response);
	//è¿™é‡Œå°±æ˜¯è·å–å“åº”bodyäº†
    if (forWebSocket && code == 101) {
      // Connection is upgrading, but we need to ensure interceptors see a non-null response body.
      response = response.newBuilder()
          .body(Util.EMPTY_RESPONSE)
          .build();
    } else {
      response = response.newBuilder()
          .body(exchange.openResponseBody(response))
          .build();
    }
	//è¯·æ±‚å¤´ä¸­Connectionæ˜¯closeï¼Œè¡¨ç¤ºè¯·æ±‚å®Œæˆåè¦å…³é—­è¿æ¥
    if ("close".equalsIgnoreCase(response.request().header("Connection"))
        || "close".equalsIgnoreCase(response.header("Connection"))) {
      exchange.noNewExchangesOnConnection();
    }
	//204ï¼ˆæ— å†…å®¹ï¼‰ã€205ï¼ˆå……å€¼å†…å®¹ï¼‰ï¼Œbodyåº”è¯¥æ˜¯ç©º
    if ((code == 204 || code == 205) && response.body().contentLength() > 0) {
      throw new ProtocolException(
          "HTTP " + code + " had non-zero Content-Length: " + response.body().contentLength());
    }
	
    return response;
  }
}
```
ä½ ä¼šå‘ç°ï¼Œæ•´ä¸ªå†…å®¹å°±æ˜¯å‰é¢è¯´çš„ä¸€å¥è¯ï¼šå†™å…¥`http`è¯·æ±‚çš„`header`å’Œ`body`ã€è¯»å–å“åº”çš„`header`å’Œ`body`ã€‚è¿™é‡Œå°±ä¸å†è§£é‡Šäº†ã€‚
è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºå†™è¯·æ±‚è¿˜æ˜¯è¯»å“åº”ï¼Œéƒ½æ˜¯ä½¿ç”¨`Exchange`å¯¹åº”çš„æ–¹æ³•ã€‚ä¸Šé¢ä¹Ÿæåˆ°è¿‡`Exchange`ç†è§£ä¸Šæ˜¯å¯¹`ExchangeCodec`çš„åŒ…è£…ï¼Œè¿™å†™æ–¹æ³•å†…éƒ¨é™¤äº†äº‹ä»¶å›è°ƒå’Œä¸€äº›å‚æ•°è·å–å¤–ï¼Œæ ¸å¿ƒå·¥ä½œéƒ½ç”± `ExchangeCodec` å¯¹è±¡å®Œæˆï¼Œè€Œ `ExchangeCodec`å®é™…ä¸Šåˆ©ç”¨çš„æ˜¯ `Okio`ï¼Œè€Œ `Okio` å®é™…ä¸Šè¿˜æ˜¯ç”¨çš„ `Socket`ã€‚
`ExchangeCodec`çš„å®ç°ç±» æœ‰å¯¹åº”`Http1.1`çš„`Http1ExchangeCodec` å’Œ å¯¹åº”`Http2.0`çš„`Http2ExchangeCodec`ã€‚å…¶ä¸­`Http2ExchangeCodec`æ˜¯ä½¿ç”¨`Http2.0`ä¸­ æ•°æ®å¸§ çš„æ¦‚å¿µå®Œæˆè¯·æ±‚å“åº”çš„è¯»å†™ã€‚å…³äº`Http1ExchangeCodec`ã€`Http2ExchangeCodec`å…·ä½“å®ç°åŸç†æ¶‰åŠ`okio`è¿™ä¸å†å±•å¼€ã€‚
æœ€åä¸€ç‚¹ï¼Œ`CallServerInterceptor`çš„`intercept`æ–¹æ³•ä¸­æ²¡æœ‰è°ƒç”¨è¿æ¥å™¨é“¾`Chain`çš„`proceed`æ–¹æ³•ï¼Œå› ä¸ºè¿™æ˜¯æœ€åä¸€ä¸ªæ‹¦æˆªå™¨å•¦ï¼
å¥½äº†ï¼Œåˆ°è¿™é‡Œæœ€åä¸€ä¸ªæ‹¦æˆªå™¨ä¹Ÿåˆ†æå®Œå•¦ï¼

### 4. æ€»ç»“
æœ¬ç¯‡åˆ†æäº†`ConnectInterceptor`ã€`CallServerInterceptor`ä¸¤ä¸ªæ‹¦æˆªå™¨çš„ä½œç”¨å’ŒåŸç†ã€‚`ConnectInterceptor`è´Ÿè´£è¿æ¥çš„è·å–ï¼Œå…¶ä¸­æ¶‰åŠåˆ°è¿æ¥æ± çš„æ¦‚å¿µï¼›`CallServerInterceptor`æ˜¯çœŸæ­£çš„ç½‘ç»œ`IO`è¯»å†™ã€‚`ConnectInterceptor`æ¶‰åŠçš„å†…å®¹è¾ƒå¤šï¼Œå®ƒæ˜¯`Okhttp`çš„æ ¸å¿ƒã€‚
ç»“åˆä¸Šä¸€ç¯‡ï¼Œæˆ‘ä»¬å·²ç»åˆ†æå®Œäº†`Okhttp`å†…éƒ¨æ‰€æœ‰çš„æ‹¦æˆªå™¨ï¼Œæœ€åç»™å‡º`Okhttp`çš„æ•´ä½“æ¶æ„å›¾(å›¾ç‰‡æ¥æº)ï¼š
![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/6/14/172b2ffdbe242418~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.awebp)

åˆ°è¿™é‡Œï¼Œ`Okhttp`æºç è§£æéƒ¨åˆ†å°±çœŸçš„ç»“æŸäº†ï¼Œå¯çœŸæ˜¯ä¸€ä¸ªæ¼«é•¿çš„è¿‡ç¨‹ï¼
ä»ä½¿ç”¨æ–¹å¼åˆ°å·¥ä½œæµç¨‹ï¼Œå†åˆ°å…·ä½“æ‹¦æˆªå™¨ï¼ŒæŒæ¡äº†è¿™å››ç¯‡æ–‡ç« çš„å†…å®¹ï¼Œåº”è¯¥è¯´å¾—ä¸Šå¯¹Okhttpæ˜¯æ¯”è¾ƒç†Ÿæ‚‰äº†ã€‚è¿™é‡Œè¿˜è®¡åˆ’ä¼šå‡ºç¬¬äº”ç¯‡ç»ˆç« ï¼Œæ¥ä»‹ç»ä¸€äº›`Okhttp`çš„å¸¸è§é—®é¢˜å’Œé«˜çº§ä½¿ç”¨æ–¹å¼ï¼Œæ•¬è¯·æœŸå¾…ï¼

```java
ä½œè€…ï¼šèƒ¡é£æ´‹
é“¾æ¥ï¼šhttps://juejin.cn/post/6844904191123685389
æ¥æºï¼šç¨€åœŸæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚
```