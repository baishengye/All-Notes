## â¤ï¸Android IPC ä¹‹ Messenger â¤ï¸

### ğŸ”¥ ç»‘å®šæœåŠ¡(Bound Services)æ¦‚è¿°
ç»‘å®šæœåŠ¡æ˜¯client-serveræ¥å£ä¸­çš„æœåŠ¡å™¨ã€‚å®ƒå…è®¸ç»„ä»¶(ä¾‹å¦‚æ´»åŠ¨)ç»‘å®šåˆ°æœåŠ¡ã€å‘é€è¯·æ±‚ã€æ¥æ”¶å“åº”å’Œæ‰§è¡Œè¿›ç¨‹é—´é€šä¿¡(IPC)ã€‚ ç»‘å®šæœåŠ¡é€šå¸¸ä»…åœ¨å®ƒä¸ºå¦ä¸€ä¸ªåº”ç”¨ç¨‹åºç»„ä»¶æä¾›æœåŠ¡æ—¶æ‰å­˜åœ¨ï¼Œå¹¶ä¸”ä¸ä¼šæ— é™æœŸåœ°åœ¨åå°è¿è¡Œã€‚

#### ğŸ’¥ åŸºç¡€çŸ¥è¯†
ç»‘å®šæœåŠ¡æ˜¯ Service ç±»çš„å®ç°ï¼Œå®ƒå…è®¸å…¶ä»–åº”ç”¨ç¨‹åºç»‘å®šåˆ°å®ƒå¹¶ä¸ä¹‹äº¤äº’ã€‚ è¦ä¸ºæœåŠ¡æä¾›ç»‘å®šï¼Œä½ å¿…é¡»å®ç° onBind() å›è°ƒæ–¹æ³•ã€‚ æ­¤æ–¹æ³•è¿”å›ä¸€ä¸ª IBinder å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å®šä¹‰äº†å®¢æˆ·ç«¯å¯ç”¨äºä¸æœåŠ¡äº¤äº’çš„ç¼–ç¨‹æ¥å£ã€‚

### ğŸ”¥ Messenger

#### ğŸ’¥ æ¦‚è¿°
ä¸€æåˆ°IPC å¾ˆå¤šäººçš„ååº”éƒ½æ˜¯ AIDLï¼Œå…¶å®å¦‚æœä»…ä»…æ˜¯å¤šè¿›ç¨‹å•çº¿ç¨‹ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨ Messenger ä¸ºä½ çš„æœåŠ¡æä¾›æ¥å£ã€‚

ä½¿ç”¨ Messenger æ¯”ä½¿ç”¨ AIDL æ›´ç®€å•ï¼Œå› ä¸º Messenger ä¼šå°†æ‰€æœ‰å¯¹æœåŠ¡çš„è°ƒç”¨æ’å…¥é˜Ÿåˆ—ã€‚

å¯¹äºå¤§å¤šæ•°åº”ç”¨ç¨‹åºï¼Œè¯¥æœåŠ¡ä¸éœ€è¦æ‰§è¡Œå¤šçº¿ç¨‹ï¼Œå› æ­¤ä½¿ç”¨ Messenger å…è®¸è¯¥æœåŠ¡ä¸€æ¬¡å¤„ç†ä¸€ä¸ªè°ƒç”¨ã€‚å¦‚æœä½ çš„ æœåŠ¡å¤šçº¿ç¨‹å¾ˆé‡è¦ï¼Œé‚£ä½ å°±è¦ç”¨åˆ°ALDLäº†ã€‚

#### ğŸ’¥ ä½¿ç”¨ Messenger æ­¥éª¤

1. è¯¥ Service å®ç°äº†ä¸€ä¸ª Handlerï¼Œè¯¥ Handler æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„æ¯æ¬¡è°ƒç”¨çš„å›è°ƒã€‚

2. è¯¥æœåŠ¡ä½¿ç”¨ Handler åˆ›å»ºä¸€ä¸ª Messenger å¯¹è±¡ï¼ˆå®ƒæ˜¯å¯¹ Handler çš„å¼•ç”¨ï¼‰ã€‚

3. Messenger åˆ›å»ºä¸€ä¸ª IBinderï¼Œè¯¥æœåŠ¡ä» onBind() è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

4. å®¢æˆ·ç«¯ä½¿ç”¨ IBinder æ¥å®ä¾‹åŒ– Messengerï¼ˆå¼•ç”¨æœåŠ¡çš„Handlerï¼‰ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨ Handler æ¥å‘æœåŠ¡å‘é€ Message å¯¹è±¡ã€‚

5. æœåŠ¡åœ¨å…¶ Handler çš„ handleMessage() ä¸­æ¥æ”¶æ¯ä¸ªæ¶ˆæ¯ã€‚


### ğŸ’¥ å®ä¾‹(Clientåˆ°Serveræ•°æ®ä¼ é€’)

#### ğŸŒ€ MessengerService.java
```java
public class MessengerService extends Service {
    public static final int MSG_SAY_HELLO = 0;
    //è®©å®¢æˆ·ç«¯å‘IncomingHandlerå‘é€æ¶ˆæ¯ã€‚
    Messenger messenger = null;

    //å½“ç»‘å®šåˆ°æœåŠ¡æ—¶ï¼Œæˆ‘ä»¬å‘æˆ‘ä»¬çš„Messengerè¿”å›ä¸€ä¸ªæ¥å£ï¼Œç”¨äºå‘æœåŠ¡å‘é€æ¶ˆæ¯ã€‚
    public IBinder onBind(Intent intent) {
        MLog.e("MessengerService:onBind");
        //åˆ›å»º Messenger å¯¹è±¡ï¼ˆå¯¹ Handler çš„å¼•ç”¨ï¼‰
        messenger = new Messenger(new IncomingHander(this));
        //è¿”å›æ”¯æŒæ­¤Messengerçš„IBinderã€‚
        return messenger.getBinder();
    }
    //å®ç°äº†ä¸€ä¸ª Handler
    static class  IncomingHander extends Handler {
        private Context appliacationContext;
        public IncomingHander(Context context) {
            appliacationContext = context.getApplicationContext();
        }

        @Override
        public void handleMessage(Message msg) {
            switch (msg.what){
                case MSG_SAY_HELLO:
                    Bundle bundle = msg.getData();
                    String string = bundle.getString("name");
                    //å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯
                    MLog.e("handleMessage:æ¥è‡ªAcitvityçš„"+string);
                    break;
                case 1:
                    
                    break;
                default:
                    super.handleMessage(msg);
            }
        }
    }
}
```

#### AndroidMainfest.xml
```xml
        <service android:name=".ipc.MessengerService"
            android:process="com.scc.ipc.messengerservice"
            android:exported="true"
            android:enabled="true"/>
```
ä½¿ç”¨ android:process å±æ€§ åˆ›å»ºä¸åŒè¿›ç¨‹ã€‚


#### ğŸŒ€ MainActivity.class
```java
public class MainActivity extends ActivityBase implements View.OnClickListener {
    Messenger mService = null;
    Messenger messenger = null;
    private boolean bound;
    private ViewStub v_stud;

    @Override
    public void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        ...
    }

    ServiceConnection connection = new ServiceConnection() {
        @Override
        public void onServiceConnected(ComponentName name, IBinder service) {
            //ä»åŸå§‹ IBinder åˆ›å»ºä¸€ä¸ª Messengerï¼Œè¯¥ IBinder ä¹‹å‰å·²ä½¿ç”¨ getBinder æ£€ç´¢åˆ°ã€‚
            mService = new Messenger(service);
            bound = true;
        }

        @Override
        public void onServiceDisconnected(ComponentName name) {
            bound = false;
        }
    };

    @Override
    public void onClick(View v) {
        switch (v.getId()) {
            case R.id.btn_bind_service:
                bindService(new Intent(MainActivity.this, MessengerService.class), connection, Context.BIND_AUTO_CREATE);
                break;
            case R.id.btn_send_msg:
                Message message = Message.obtain(null, MessengerService.MSG_SAY_HELLO);
                Bundle bundle = new Bundle();
                bundle.putString("name","Scc");
                message.setData(bundle);
                try {
                    mService.send(message);
                } catch (RemoteException e) {
                    e.printStackTrace();
                }
                break;

        }
    }
    @Override
    protected void onStop() {
        super.onStop();
        if (bound) {
            unbindService(connection);
            bound = false;
        }
    }
}
```
ğŸŒ€ è¿è¡Œæ•ˆæœå¦‚ä¸‹
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/56bb8b2e9aad4e73aeb6596d7fec2a0f~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)
ä¸¤ä¸ªè¿›ç¨‹ä¹Ÿå­˜åœ¨ç€ï¼Œä¹Ÿå®Œæˆäº†è¿›ç¨‹é—´çš„é€šä¿¡ï¼Œå¹¶æŠŠæ•°æ®ä¼ é€’è¿‡å»äº†ã€‚


### ğŸ’¥ å®ä¾‹(Serverå°†æ•°æ®ä¼ å›Client)
æˆ‘ä¸ä»…æƒ³å°†æ¶ˆæ¯ä¼ é€’ç»™ Server ï¼Œè¿˜æƒ³è®© Server å°†æ•°æ®å¤„ç†åä¼ ä¼šClientã€‚

#### ğŸŒ€ MessengerService.java
```java
public class MessengerService extends Service {
    /** ç”¨äºæ˜¾ç¤ºå’Œéšè—æˆ‘ä»¬çš„é€šçŸ¥ã€‚ */
    ArrayList<Messenger> mClients = new ArrayList<Messenger>();
    /** ä¿å­˜å®¢æˆ·ç«¯è®¾ç½®çš„æœ€åä¸€ä¸ªå€¼ã€‚ */
    int mValue = 0;

    /**
     * æ•°ç»„ä¸­æ·»åŠ  Messenger (æ¥è‡ªå®¢æˆ·ç«¯)ã€‚
     * Message çš„ replyTo å­—æ®µå¿…é¡»æ˜¯åº”è¯¥å‘é€å›è°ƒçš„å®¢æˆ·ç«¯çš„ Messengerã€‚
     */
    public static final int MSG_REGISTER_CLIENT = 1;

    /**
     * æ•°ç»„ä¸­åˆ é™¤ Messenger (æ¥è‡ªå®¢æˆ·ç«¯)ã€‚
     * Message çš„ replyTo å­—æ®µå¿…é¡»æ˜¯ä¹‹å‰ç”¨ MSG_REGISTER_CLIENT ç»™å‡ºçš„å®¢æˆ·ç«¯çš„ Messengerã€‚
     */
    public static final int MSG_UNREGISTER_CLIENT = 2;
    /**
     * ç”¨äºè®¾ç½®æ–°å€¼ã€‚
     * è¿™å¯ä»¥å‘é€åˆ°æœåŠ¡ä»¥æä¾›æ–°å€¼ï¼Œå¹¶å°†ç”±æœåŠ¡å‘é€ç»™å…·æœ‰æ–°å€¼çš„ä»»ä½•æ³¨å†Œå®¢æˆ·ç«¯ã€‚
     */
    public static final int MSG_SET_VALUE = 3;
    //è®©å®¢æˆ·ç«¯å‘IncomingHandlerå‘é€æ¶ˆæ¯ã€‚
    Messenger messenger = null;

    //å½“ç»‘å®šåˆ°æœåŠ¡æ—¶ï¼Œæˆ‘ä»¬å‘æˆ‘ä»¬çš„Messengerè¿”å›ä¸€ä¸ªæ¥å£ï¼Œç”¨äºå‘æœåŠ¡å‘é€æ¶ˆæ¯ã€‚
    public IBinder onBind(Intent intent) {
        MLog.e("MessengerService-onBind");
        //åˆ›å»º Messenger å¯¹è±¡ï¼ˆå¯¹ Handler çš„å¼•ç”¨ï¼‰
        messenger = new Messenger(new IncomingHander(this));
        //è¿”å›æ”¯æŒæ­¤Messengerçš„IBinderã€‚
        return messenger.getBinder();
    }
    //å®ç°äº†ä¸€ä¸ª Handler
    class  IncomingHander extends Handler {
        private Context appliacationContext;
        public IncomingHander(Context context) {
            appliacationContext = context.getApplicationContext();
        }

        @Override
        public void handleMessage(Message msg) {
            switch (msg.what){
                case MSG_REGISTER_CLIENT:
                    mClients.add(msg.replyTo);
                    break;
                case MSG_UNREGISTER_CLIENT:
                    mClients.remove(msg.replyTo);
                    break;
                case MSG_SET_VALUE:
                    mValue = msg.arg1;
                    for (int i=mClients.size()-1; i>=0; i--) {
                        try {
                            mClients.get(i).send(Message.obtain(null,
                                    MSG_SET_VALUE, mValue, 0));
                        } catch (RemoteException e) {
                            // å®¢æˆ·ç«¯æ²¡äº†ã€‚ ä»åˆ—è¡¨ä¸­åˆ é™¤å®ƒ;
                            //ä»åå¾€å‰å®‰å…¨ï¼Œä»å‰å¾€åéå†æ•°ç»„è¶Šç•Œã€‚
                            mClients.remove(i);
                        }
                    }
                default:
                    super.handleMessage(msg);
            }
        }
    }
}
å¤åˆ¶ä»£ç 
ğŸŒ€ MainActivity.java
public class MainActivity extends ActivityBase implements View.OnClickListener {
    Messenger mService = null;
    Messenger messenger = null;
    private boolean bound;
    private ViewStub v_stud;

    @Override
    public void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        ...
    }

    ServiceConnection connection = new ServiceConnection() {
        @Override
        public void onServiceConnected(ComponentName name, IBinder service) {
            //ä»åŸå§‹ IBinder åˆ›å»ºä¸€ä¸ª Messengerï¼Œè¯¥ IBinder ä¹‹å‰å·²ä½¿ç”¨ getBinder æ£€ç´¢åˆ°ã€‚
            mService = new Messenger(service);
            bound = true;
        }

        @Override
        public void onServiceDisconnected(ComponentName name) {
            bound = false;
        }
    };
    static class ReturnHander extends Handler {
        @Override
        public void handleMessage(Message msg) {
            switch (msg.what) {
                case MessengerService.MSG_SET_VALUE:
                    //æˆ‘è¦èµ·é£ï¼šæ­¤å¤„å¤„ç†
                    MLog.e("Received from service: " + msg.arg1);
                    break;
                default:
                    super.handleMessage(msg);
            }
        }
    }
    @Override
    public void onClick(View v) {
        switch (v.getId()) {
            case R.id.btn_bind_service:
                bindService(new Intent(MainActivity.this, MessengerService.class), connection, Context.BIND_AUTO_CREATE);
                break;
            case R.id.btn_send_msg:
                try {
                    mMessenger = new Messenger(new ReturnHander());
                    Message msg = Message.obtain(null,
                            MessengerService.MSG_REGISTER_CLIENT);
                    msg.replyTo = mMessenger;
                    //å…ˆå‘ä¸€åˆ™æ¶ˆæ¯æ·»åŠ Messengerï¼šmsg.replyTo = mMessenger;
                    mService.send(msg);

                    // Give it some value as an example.
                    msg = Message.obtain(null,
                            MessengerService.MSG_SET_VALUE, this.hashCode(), 0);
                    //ä¼ å…¥çš„arg1å€¼:this.hashCode()
                    mService.send(msg);
                } catch (RemoteException e) {
                    e.printStackTrace();
                }
                break;

        }
    }
    @Override
    protected void onStop() {
        super.onStop();
        if (bound) {
            unbindService(connection);
            bound = false;
        }
    }
}
```
ğŸŒ€ è¿è¡Œæ•ˆæœå¦‚ä¸‹
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/83f34f1183f54a3e93629032debb2748~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)
æˆ‘ä»¬åœ¨MainActivity çš„ Handler.sendMessger()ä¸­æ¥æ”¶åˆ°äº†æ¥è‡ª MesengerService çš„æ¶ˆæ¯ ã€‚
æœ¬æ¬¡ Messenger è¿›ç¨‹é—´é€šä¿¡é½æ´»ï¼Œè¿™åªæ˜¯ä¸ªç®€å•çš„Demoã€‚æœ€åå’±ä»¬çœ‹ä¸€æ³¢æºç ã€‚

#### ğŸ”¥ Messenger æºç 
```java
Messenger.java
public final class Messenger implements Parcelable {
    private final IMessenger mTarget;
    public Messenger(Handler target) {
        mTarget = target.getIMessenger();
    }
    public void send(Message message) throws RemoteException {
        mTarget.send(message);
    }
    public IBinder getBinder() {
        return mTarget.asBinder();
    }
    ...
    public Messenger(IBinder target) {
        mTarget = IMessenger.Stub.asInterface(target);
    }
}
```
ç„¶åä½ ä¼šå‘ç° åªè¦ä»£ç è¿˜æ˜¯åœ¨ `IMessenger` é‡Œé¢ï¼Œå’±ä»¬å»æ‰¾æ‰¾ã€‚

```java
IMessenger.aidl
package android.os;

import android.os.Message;

/** @hide */
oneway interface IMessenger {
    void send(in Message msg);
}
å¤åˆ¶ä»£ç 
new Messenger(Handler handelr)
è¿™é‡Œå…¶å®æ˜¯ç”¨Handler è°ƒç”¨ getIMessenger() ã€‚å’±ä»¬å»Handler.classé‡Œé¢è½¬è½¬ã€‚
    @UnsupportedAppUsage
    final IMessenger getIMessenger() {
        synchronized (mQueue) {
            if (mMessenger != null) {
                return mMessenger;
            }
            mMessenger = new MessengerImpl();
            return mMessenger;
        }
    }
    //åˆ›å»ºäº†Messengerå®ç°ç±»
    private final class MessengerImpl extends IMessenger.Stub {
        public void send(Message msg) {
            msg.sendingUid = Binder.getCallingUid();
            //Messengerè°ƒç”¨send()æ–¹æ³•ï¼Œé€šè¿‡Handlerå‘é€æ¶ˆæ¯ã€‚
            //ç„¶ååœ¨æœåŠ¡ç«¯é€šè¿‡Handlerçš„handleMessge(msg)æ¥æ”¶è¿™ä¸ªæ¶ˆæ¯ã€‚
            Handler.this.sendMessage(msg);
        }
    }
```
```java
new Messenger(IBinder target)
package android.os;
/** @hide */
public interface IMessenger extends android.os.IInterface
{
  /** Default implementation for IMessenger. */
  public static class Default implements android.os.IMessenger
  {
    @Override public void send(android.os.Message msg) throws android.os.RemoteException
    {
    }
    @Override
    public android.os.IBinder asBinder() {
      return null;
    }
  }
  /** Local-side IPC implementation stub class. */
  public static abstract class Stub extends android.os.Binder implements android.os.IMessenger
  {
    /** Construct the stub at attach it to the interface. */
    public Stub()
    {
      this.attachInterface(this, DESCRIPTOR);
    }
    /**
     * Cast an IBinder object into an android.os.IMessenger interface,
     * generating a proxy if needed.
     */
    public static android.os.IMessenger asInterface(android.os.IBinder obj)
    {
      if ((obj==null)) {
        return null;
      }
      android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR);
      //åˆ¤æ–­æ˜¯å¦åœ¨åŒä¸€è¿›ç¨‹ã€‚
      if (((iin!=null)&&(iin instanceof android.os.IMessenger))) {
        //åŒä¸€è¿›ç¨‹
        return ((android.os.IMessenger)iin);
      }
      //ä»£ç†å¯¹è±¡
      return new android.os.IMessenger.Stub.Proxy(obj);
    }
    @Override public android.os.IBinder asBinder()
    {
      return this;
    }
    ...
  }
  public void send(android.os.Message msg) throws android.os.RemoteException;
}
```
çœ‹äº†ä¸Šé¢ä»£ç ä½ ä¼šå‘ç°è¿™ä¸å°±æ˜¯ä¸ªaidlå—ï¼Ÿ ä»€ä¹ˆæ˜¯aidlï¼Œå’±ä»¬ä¸‹ä¸€ç¯‡ç»§ç»­è®²åˆ°ã€‚

```yml
ä½œè€…ï¼šAndroidå¸…æ¬¡
é“¾æ¥ï¼šhttps://juejin.cn/post/7022881022438015007
æ¥æºï¼šç¨€åœŸæ˜é‡‘
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚
```